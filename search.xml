<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Ubuntu 20.04 網路綁定</title>
      <link href="2021/02/04/ubuntu-network-bond/"/>
      <url>2021/02/04/ubuntu-network-bond/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因為常用到，所以特此紀錄方便日後查詢。</p><p>使用 <a href="https://help.ubuntu.com/community/UbuntuBonding" target="_blank" rel="noopener">bonding</a> 模組，將多個網路線綁定。</p><hr><h2 id="綁定模式"><a href="#綁定模式" class="headerlink" title="綁定模式"></a>綁定模式</h2><p>綁定方法總共有 7 種，可根據需求選擇適合的模式。</p><p>詳細說明可參考<a href="https://www.kernel.org/doc/Documentation/networking/bonding.txt" target="_blank" rel="noopener">此文件</a></p><ul><li>mode 0 : balance-rr</li><li>mode 1 : active-backup</li><li>mode 2 : balance-xor</li><li>mode 3 : broadcast</li><li>mode 4 : 802.3ad</li><li>mode 5 : balance-tlb</li><li>mode 6 : balance-alb</li></ul><div class="note info">            <p>如果選擇 mode 4 (802.3ad)，交換器也需要設定為 <code>802.3ad</code> 模式。</p>          </div><h2 id="設定步驟"><a href="#設定步驟" class="headerlink" title="設定步驟"></a>設定步驟</h2><h3 id="確認驅動"><a href="#確認驅動" class="headerlink" title="確認驅動"></a>確認驅動</h3><p>確認是否有 bonding 模組驅動，理論上新版系統的都已內建，較舊的系統則需安裝驅動。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modinfo bonding | more</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/check.PNG" class="" title="確認驅動"><p>如未找到，請安裝套件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ifenslave</span><br></pre></td></tr></table></figure><h3 id="載入模組"><a href="#載入模組" class="headerlink" title="載入模組"></a>載入模組</h3><p>載入 bonding 模組</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe bonding</span><br></pre></td></tr></table></figure><h3 id="確認模組已經加載"><a href="#確認模組已經加載" class="headerlink" title="確認模組已經加載"></a>確認模組已經加載</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsmod | grep bonding</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/show.PNG" class="" title="確認模組已經加載"><h3 id="開機自動加載"><a href="#開機自動加載" class="headerlink" title="開機自動加載"></a>開機自動加載</h3><p>將 bonding 模組設定開機自動加載</p><p>編輯設定檔</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/modules</span><br></pre></td></tr></table></figure><p>填入 <code>bonding</code> </p><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/config.PNG" class="" title="&#x2F;etc&#x2F;modules 設定檔"><h3 id="查詢網路介面名稱"><a href="#查詢網路介面名稱" class="headerlink" title="查詢網路介面名稱"></a>查詢網路介面名稱</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip link</span><br></pre></td></tr></table></figure><p>如下範例，可以看到有兩個網孔，網路介面名稱分別為 <code>enp13s0</code> , <code>enp0s31f6</code> </p><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/IP_link.PNG" class="" title="GPU 網路介面名稱"><h3 id="編輯網路設定檔"><a href="#編輯網路設定檔" class="headerlink" title="編輯網路設定檔"></a>編輯網路設定檔</h3><p>每台系統預設的設定檔檔名未必一樣，可在 <code>/etc/netplan</code> 找到副檔名為 <code>yaml</code> 的設定檔，下圖為例，檔案名稱為 <code>01-netcfg.yaml</code>。</p><p>列出設定檔名稱</p><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/show_yaml.PNG" class="" title="GPU 列出設定檔名稱"><p>編輯設定檔</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/01-netcfg.yaml</span><br></pre></td></tr></table></figure><h3 id="填入網路綁定資訊"><a href="#填入網路綁定資訊" class="headerlink" title="填入網路綁定資訊"></a>填入網路綁定資訊</h3><p>假設綁定模式為 <code>802.3ad</code>，也稱為 LACP (Link Aggregation Control Protocol)，並選擇將 <code>enp13s0</code> , <code>enp0s31f6</code> 這兩個網路介面綁定。</p><p>固定 IP 設定範例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp13s0:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enp0s31f6:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">bonds:</span></span><br><span class="line">    <span class="attr">bond4:</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">enp13s0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">enp0s31f6</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"192.168.0.200/24"</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="string">"192.168.0.254"</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">        <span class="attr">addresses:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"8.8.8.8"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">"1.1.1.1"</span></span><br></pre></td></tr></table></figure><p>DHCP IP 設定範例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp13s0:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enp0s31f6:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">bonds:</span></span><br><span class="line">    <span class="attr">bond4:</span></span><br><span class="line">      <span class="attr">interfaces:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">enp13s0</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">enp0s31f6</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">802.</span><span class="string">3ad</span></span><br><span class="line">        <span class="attr">lacp-rate:</span> <span class="string">fast</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="啟用網路設定"><a href="#啟用網路設定" class="headerlink" title="啟用網路設定"></a>啟用網路設定</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><p>如果擔心設定有問題或失敗，可以使用 <code>try</code>指令，在執行 <code>120</code> 秒後復原原本設定。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan try</span><br></pre></td></tr></table></figure><h3 id="查詢網路狀態"><a href="#查詢網路狀態" class="headerlink" title="查詢網路狀態"></a>查詢網路狀態</h3><p>查詢綁定後的網路資訊</p><img src= "/img/loading.gif" data-src="/2021/02/04/ubuntu-network-bond/ifconfig.PNG" class="" title="GPU 查詢網路綁定後的狀態">]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NETWORK </tag>
            
            <tag> BOND </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 20.04 網路設定</title>
      <link href="2021/02/03/ubuntu-network/"/>
      <url>2021/02/03/ubuntu-network/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因為常用到，所以特此紀錄方便日後查詢。</p><p>使用 <a href="https://netplan.io/" target="_blank" rel="noopener">netplan</a> 設定 Ubuntu 網路。</p><hr><h2 id="設定步驟"><a href="#設定步驟" class="headerlink" title="設定步驟"></a>設定步驟</h2><h3 id="查詢網路介面名稱"><a href="#查詢網路介面名稱" class="headerlink" title="查詢網路介面名稱"></a>查詢網路介面名稱</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip link</span><br></pre></td></tr></table></figure><p>如下範例，可以看到有兩個網孔，網路介面名稱分別為 <code>enp13s0</code> , <code>enp0s31f6</code> </p><img src= "/img/loading.gif" data-src="/2021/02/03/ubuntu-network/IP_link.PNG" class="" title="GPU 網路介面名稱"><h3 id="編輯設定檔"><a href="#編輯設定檔" class="headerlink" title="編輯設定檔"></a>編輯設定檔</h3><p>每台系統預設的設定檔檔名未必一樣，可在 <code>/etc/netplan</code> 找到副檔名為 <code>yaml</code> 的設定檔，下圖為例，檔案名稱為 <code>01-netcfg.yaml</code>。</p><p>列出設定檔名稱</p><img src= "/img/loading.gif" data-src="/2021/02/03/ubuntu-network/show_yaml.PNG" class="" title="GPU 列出設定檔名稱"><p>編輯設定檔</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/netplan/01-netcfg.yaml</span><br></pre></td></tr></table></figure><h3 id="填入網路資訊"><a href="#填入網路資訊" class="headerlink" title="填入網路資訊"></a>填入網路資訊</h3><p>固定 IP 設定範例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp13s0:</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">[</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.200</span><span class="string">/24</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">gateway4:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.254</span></span><br><span class="line">      <span class="attr">nameservers:</span></span><br><span class="line">          <span class="attr">addresses:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">"8.8.8.8"</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">"1.1.1.1"</span></span><br></pre></td></tr></table></figure><p>DHCP IP 設定範例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">enp0s31f6:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="啟用網路設定"><a href="#啟用網路設定" class="headerlink" title="啟用網路設定"></a>啟用網路設定</h3><p>啟用網路設定</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><p>如果擔心設定有問題或失敗，可以使用 <code>try</code>指令，在執行 <code>120</code> 秒後復原原本設定。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan try</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NETWORK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 20.04 NVME SSD 開機失敗</title>
      <link href="2021/01/25/ubuntu-install-nvme/"/>
      <url>2021/01/25/ubuntu-install-nvme/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>部分型號的 NVME SSD，如果將系統裝在此硬碟上，會遇到開機失敗的情況。<br>解決方法就是在開機時，重新引導至 NVME 的磁區。</p><hr><h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><p>開機後進入 GRUB 選單，按 <code>e</code> 編輯，在 <code>linux</code> 那行的尾端填入以下指令，最後用 <code>Crtl+x</code> 或 <code>F10</code> 開機。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvme_core.default_ps_max_latency_us=5500 acpi=off</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2021/01/25/ubuntu-install-nvme/grub.png" class="" title="GRUB 選單範例"><p>成功開機後，編輯 <code>/etc/default/grub</code>，將此設定寫入開機指令，即可解決此問題。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/grub</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT="nvme_core.default_ps_max_latency_us=5500"</span><br><span class="line">GRUB_CMDLINE_LINUX="acpi=off"</span><br></pre></td></tr></table></figure><p>重啟設定，完成！</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> OS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LINUX </tag>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 延長終端機連線自動退出時間</title>
      <link href="2020/11/23/ubuntu-ssh-timeout/"/>
      <url>2020/11/23/ubuntu-ssh-timeout/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 ssh 終端機介面，如一段時間未操作，則連線會自動退出，如不想中斷或想延長中斷時間，可在環境變數中設定。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timed out waiting for input: auto-logou</span><br></pre></td></tr></table></figure><hr><h2 id="設置"><a href="#設置" class="headerlink" title="設置"></a>設置</h2><p>編輯環境變數</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 方法一</span></span><br><span class="line">sudo vim ~/.bashrc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法二</span></span><br><span class="line">sudo vim /etc/profile</span><br></pre></td></tr></table></figure><p>加入自動退出的時間，<code>0</code> 為永不退出，大於 <code>0</code> 則是幾秒後退出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 永不退出</span></span><br><span class="line">export TMOUT=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 300 秒後退出</span></span><br><span class="line">export TMOUT=300</span><br></pre></td></tr></table></figure><p>重新啟用環境變數</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UBUNTU </tag>
            
            <tag> SSH </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NVIDIA GPU 開啟持久化模式</title>
      <link href="2020/11/14/nvidia-gpu-persistenced/"/>
      <url>2020/11/14/nvidia-gpu-persistenced/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每當一個或多個客戶端打開設備文件時，GPU狀態就會保持加載在驅動程序中。一旦所有客戶端都關閉了設備文件，除非啟用了持久化模式，否則GPU狀態將被卸載。</p><p>為避免每次初始化所造成的延遲而影響到效能，可開啟GPU持久化模式。</p><hr><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>指定 GPU 開啟持久化模式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi -i &lt;GPU ID&gt; -pm 1</span><br></pre></td></tr></table></figure><p>指定 GPU 關閉持久化模式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi -i &lt;GPU ID&gt; -pm 0</span><br></pre></td></tr></table></figure><div class="note info">            <p>如未指定 GPU，則代表全部 GPU 都開啟或關閉</p>          </div><img src= "/img/loading.gif" data-src="/2020/11/14/nvidia-gpu-persistenced/pm.png" class="" title="開啟持久化範例"><hr><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>方法一在機器重新啟動後，設定將會清空，如要保留則需寫入 <code>service</code> 中</p><p>編輯 <code>/lib/systemd/system/nvidia-persistenced.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /lib/systemd/system/nvidia-persistenced.service</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=NVIDIA Persistence Daemon</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/var/run/nvidia-persistenced/nvidia-persistenced.pid</span><br><span class="line">Restart=always</span><br><span class="line">ExecStart=/usr/bin/nvidia-persistenced --verbose</span><br><span class="line">ExecStopPost=/bin/rm -rf /var/run/nvidia-persistenced/*</span><br><span class="line">TimeoutSec=300</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>啟用服務</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable nvidia-persistenced</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> Install </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
            <tag> GPU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Multi-Instance GPU (MIG) 設定</title>
      <link href="2020/10/29/nvidia-A100-MIG/"/>
      <url>2020/10/29/nvidia-A100-MIG/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Multi-Instance GPU（MIG）功能使 NVIDIA A100 GPU 可以安全地切割為多達七個用於 CUDA 應用的獨立 GPU 實例，從而為多個用戶提供獨立的 GPU 資源，以優化 GPU 的利用率。此功能對於 GPU 工作負載利用率低的特別有用，因此使用 MIG 技術，可在單張 GPU 上並行運行不同的工作負載以最大化利用率。</p><div class="note info">            <p>目前只有 NVIDIA Tesla A100 擁有這個功能。</p>          </div><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/mig.png" class="" title="Multi-Instance GPU（MIG）示意圖"><hr><h2 id="名詞解釋"><a href="#名詞解釋" class="headerlink" title="名詞解釋"></a>名詞解釋</h2><ul><li>GPU Engine : GPU Engine 是 GPU 上的工作引擎，如 copy engine (CE)、DMAs、NVDEC、NVENC 等等。</li><li>GPU Memory Slice : GPU Memory Slice 是 GPU 內存的最小單位，一張 GPU 的內存總共由 8 個 GPU Memory Slice 所組成。</li><li>GPU SM Slice : GPU SM Slice 是 GPU SM 的最小單位，一張 GPU 的 SM 總共由 7 個 GPU SM Slice 所組成。</li><li>GPU Slice : GPU Slice 是 GPU 的最小單位，它是由一個 GPU Memory Slice 和一個 GPU SM Slice 所組成。</li><li>GPU Instance (GI) : GPU Instance 是 GPU slices 和 GPU engine 的組合，GPU Instance 中會共享所有 GPU slices 和 GPU engine。其中每個 GPU Instance 可再進一步細分為 Compute Instance。</li><li>Compute Instance (CI) : Compute Instance 是其父類別 GPU Instance 的子集。</li></ul><hr><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><ul><li>MIG 模式只能在 CUDA 11 / R450 的 Linux 系統使用，目前驅動版本為 <code>450.80.02</code>。</li><li>在設定 MIG 時，使用者須擁有超級用戶的權限。</li><li>一旦 GPU 為 MIG 模式，即可動態的設置 GPU，無須重啟。</li><li>當 GPU 為 MIG 模式，不支援 graphics APIs，如 OpenGL, Vulkan 等等。</li><li>當 GPU 為 MIG 模式，不支援 GPU to GPU P2P。</li><li>當 GPU 為 MIG 模式，CUDA 應用程式會將 GPU Instance 中的 Compute Instance 視為單個 CUDA 設備。</li></ul><hr><h2 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h2><p>GPU 驅動安裝可參考此<a href="https://roychou121.github.io/2020/07/12/ubuntu-install-gpu-driver/">文章</a>，請下載 <code>450.80.02</code> 或更新的版本。</p><hr><h2 id="MIG-設定"><a href="#MIG-設定" class="headerlink" title="MIG 設定"></a>MIG 設定</h2><h3 id="建立流程"><a href="#建立流程" class="headerlink" title="建立流程"></a>建立流程</h3><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/createp.PNG" class="" title="建立 MIG 流程"><h4 id="啟用-MIG-模式"><a href="#啟用-MIG-模式" class="headerlink" title="啟用 MIG 模式"></a>啟用 MIG 模式</h4><p>通常預設 MIG 模式是未啟用的狀態，首先要先指定 GPU 來啟用 MIG。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi -i 0 -mig 1</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/mig1.PNG" class="" title="啟用 MIG 模式"><h4 id="查看-GI-可用組合"><a href="#查看-GI-可用組合" class="headerlink" title="查看 GI 可用組合"></a>查看 GI 可用組合</h4><p>總共有五種模式可以選擇，其中 <code>Instances</code> 可查詢剩餘可切割的數量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -lgip</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/lgip.PNG" class="" title="查看 GI 可用組合"><p>以 NVIDIA A100 40G 為例，最大利用率的排列組合如下圖，可根據需求做選擇。</p><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/migall.PNG" class="" title="全部 GI 的排列組合"><div class="note warning">            <p>在建立 GI 的順序很重要，建議由大建到小(如上圖須由左到右)，以免發生記憶體破碎的問題。</p>          </div><!-- GI 其位置及對應的 ID 表如下<img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/placement.PNG" class="" title="GI 其位置及對應的 ID 表"> --><h4 id="建立-GI"><a href="#建立-GI" class="headerlink" title="建立 GI"></a>建立 GI</h4><p>假設我要建立兩個 <code>3g.20gb</code> 的 GI，建立指令可以用 <code>Name</code> 或 <code>ID</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ID</span></span><br><span class="line">sudo nvidia-smi mig -i 0 -cgi 9</span><br><span class="line"><span class="meta">#</span><span class="bash"> Name</span></span><br><span class="line">sudo nvidia-smi mig -i 0 -cgi 3g.20gb</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/cgi.PNG" class="" title="建立 GI"><p>查詢已經建立的 GI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -lgi</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/lgi.PNG" class="" title="查詢 GI"><h4 id="查看-CI-可用組合"><a href="#查看-CI-可用組合" class="headerlink" title="查看 CI 可用組合"></a>查看 CI 可用組合</h4><p>指定 GI (GI Instance ID)，來查詢其 CI 可用的組合，<code>*</code>為預設 CI。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -gi 1 -lcip</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/lcip.PNG" class="" title="查看 CI 可用組合"><h4 id="建立-CI"><a href="#建立-CI" class="headerlink" title="建立 CI"></a>建立 CI</h4><p>假設我要建立兩個 <code>1c.3g.20gb</code> 的 GI，建立指令可以用 <code>Name</code> 或 <code>ID</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ID</span></span><br><span class="line">sudo nvidia-smi mig -i 0 -gi 0 -cci 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Name</span></span><br><span class="line">sudo nvidia-smi mig -i 0 -gi 1 -cci 1c.3g.20gb</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/cci.PNG" class="" title="建立 CI"><p>查詢已經建立的 CI (指定 GI)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -gi 1 -lci</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/lci.PNG" class="" title="查詢 CI"><div class="note info">            <p>如果在建 GI 時，想要用預設的 CI，在建GI時加入 <code>-C</code> 參數即可。<br>GPU Driver &gt; <code>450.80.02</code> 才有此功能。</p><p>範例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -cgi 9 -C</span><br></pre></td></tr></table></figure>          </div><h3 id="移除流程"><a href="#移除流程" class="headerlink" title="移除流程"></a>移除流程</h3><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/destroyp.PNG" class="" title="移除 MIG 流程"><h4 id="移除-CI"><a href="#移除-CI" class="headerlink" title="移除 CI"></a>移除 CI</h4><p>指定 GI 及 CI 來移除 CI。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -gi 1 -ci 0,1 -dci</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/dci.PNG" class="" title="移除 CI"><h4 id="移除-GI"><a href="#移除-GI" class="headerlink" title="移除 GI"></a>移除 GI</h4><p>指定 GI 來移除 GI。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi mig -i 0 -gi 1 -dci</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/dgi.PNG" class="" title="移除 GI"><h4 id="關閉-MIG-模式"><a href="#關閉-MIG-模式" class="headerlink" title="關閉 MIG 模式"></a>關閉 MIG 模式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nvidia-smi -i 0 -mig 0</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/mig0.PNG" class="" title="關閉 MIG 模式"><hr><h2 id="使用-MIG"><a href="#使用-MIG" class="headerlink" title="使用 MIG"></a>使用 MIG</h2><p>假設目前 GPU MIG 切法如下，一個 <code>2g.10gb</code>、三個 <code>1c.3g.20gb</code></p><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/ex.PNG" class="" title="MIG 範例"><p>可以用 <code>GPU ID + MIG DEV ID</code> 或 <code>UUID</code> 來指派 MIG GPU</p><h3 id="用-ID-來指派-GPU"><a href="#用-ID-來指派-GPU" class="headerlink" title="用 ID 來指派 GPU"></a>用 ID 來指派 GPU</h3><p>ID 查詢如下圖，假設我要指派 <code>GPU 0</code> 上的 <code>MIG DEV 1</code> 和 <code>MIG DEV 3</code></p><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/migid.PNG" class="" title="MIG ID"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --gpus '"device=0:1,0:3"' nvcr.io/nvidia/tensorflow:20.11-tf2-py3 bash</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/runmig.PNG" class="" title="透過 docker 來跑 CUDA 應用程式"><p>查詢可用的 MIG GPU</p><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/exmignvidiasmi.PNG" class="" title="查詢可用的 MIG GPU"><h3 id="用-UUID-來指派-GPU"><a href="#用-UUID-來指派-GPU" class="headerlink" title="用 UUID 來指派 GPU"></a>用 UUID 來指派 GPU</h3><p>UUID 查詢如下圖，假設我要指派 <code>MIG-GPU-bc104fe1-14dd-ddc0-dae2-f13f99547443/2/2</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi -L</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/uuid.PNG" class="" title="MIG UUID"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --gpus '"device=MIG-GPU-bc104fe1-14dd-ddc0-dae2-f13f99547443/2/2"' nvcr.io/nvidia/tensorflow:20.11-tf2-py3 bash</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/runmiguuid.PNG" class="" title="透過 docker 來跑 CUDA 應用程式"><p>查詢可用的 MIG GPU</p><img src= "/img/loading.gif" data-src="/2020/10/29/nvidia-A100-MIG/exmignvidiasmiuuid.PNG" class="" title="查詢可用的 MIG GPU">]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
            <tag> A100 </tag>
            
            <tag> MIG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 20.04 建置 Kubernetes (支援 GPU)</title>
      <link href="2020/10/02/nvidia-deepops/"/>
      <url>2020/10/02/nvidia-deepops/</url>
      
        <content type="html"><![CDATA[<div class="note info">            <p>2021/02/13 軟體版本更新至 v20.12</p>          </div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Kubernetes（K8s）是一個開源系統，用於自動化容器應用程序的部署，擴展和管理。<br>然而安裝 K8s 系統相當繁瑣，對於新手來說會遇到各式各樣的問題，更別說要建構一整座叢集了。好消息是，目前越來越多簡化 K8s 安裝步驟的工具，本章就要來介紹由 NVIDIA 維運的建置工具 <a href="https://github.com/NVIDIA/deepops" target="_blank" rel="noopener">DeepOps</a>。</p><hr><h2 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h2><p>DeepOps 項目主要用於快速佈署 Kubernetes 及 Slurm 在 GPU 服務器叢集和共享單個強大節點（例如 <a href="https://www.nvidia.com/zh-tw/data-center/dgx-systems/" target="_blank" rel="noopener">NVIDIA DGX Systems</a>）的最佳實踐。DeepOps 具高彈性，可以進行調整或以模塊化方式使用，以匹配特定使用情境的集群需求。</p><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul><li>利用 Ansible 提供點到點來設置整個群集管理堆棧</li><li>提供腳本可用於快速部署 Kubeflow 和連接 NFS 存儲</li><li>可安裝 Slurm，Kubernetes 或兩者的混合 (Slurm 安裝將於日後另行介紹)</li><li>提供 K8s 儀錶板及資源監控介面</li></ul><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><ul><li>20.12</li></ul><table><thead><tr><th align="center">Component</th><th align="center">v20.12</th></tr></thead><tbody><tr><td align="center">Kubespray</td><td align="center"><a href="https://github.com/kubernetes-incubator/kubespray/tree/75d648cae53eb6b83acb9b75b868ea29eec480d3" target="_blank" rel="noopener">75d648c</a></td></tr><tr><td align="center"><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener">Kubernetes</a></td><td align="center">1.18.10</td></tr><tr><td align="center"><a href="https://github.com/coreos/etcd" target="_blank" rel="noopener">Etcd</a></td><td align="center">3.4.3</td></tr><tr><td align="center"><a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a></td><td align="center">19.03.14</td></tr><tr><td align="center"><a href="https://github.com/projectcalico/calico" target="_blank" rel="noopener">Calico</a></td><td align="center">3.15.2</td></tr><tr><td align="center"><a href="https://helm.sh/" target="_blank" rel="noopener">Helm</a></td><td align="center">3.1.2</td></tr><tr><td align="center"><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Dashboard</a></td><td align="center">2.0.3</td></tr><tr><td align="center"><a href="https://ngc.nvidia.com/catalog/containers/nvidia:k8s:dcgm-exporter" target="_blank" rel="noopener">DCGM Exporter</a></td><td align="center">2.0.10-2.1.0-rc.1</td></tr><tr><td align="center"><a href="https://prometheus-community.github.io/helm-charts" target="_blank" rel="noopener">Monitoring</a></td><td align="center">10.0.2</td></tr></tbody></table><hr><h2 id="建置範例"><a href="#建置範例" class="headerlink" title="建置範例"></a>建置範例</h2><h3 id="架構"><a href="#架構" class="headerlink" title="架構"></a>架構</h3><table><thead><tr><th align="center">Hostname</th><th align="center">IP Address</th><th align="center">IP Interface</th><th align="center">SSH Port</th><th align="center">OS</th><th align="center">GPU</th><th align="center">Role</th></tr></thead><tbody><tr><td align="center">k8sm01</td><td align="center">192.168.149.128</td><td align="center">ens33</td><td align="center">22</td><td align="center">Ubuntu 20.04.2</td><td align="center">NO</td><td align="center">Master Node</td></tr><tr><td align="center">k8sm02</td><td align="center">192.168.149.129</td><td align="center">ens33</td><td align="center">22</td><td align="center">Ubuntu 20.04.2</td><td align="center">NO</td><td align="center">Master Node</td></tr><tr><td align="center">k8sm03</td><td align="center">192.168.149.130</td><td align="center">ens33</td><td align="center">22</td><td align="center">Ubuntu 20.04.2</td><td align="center">NO</td><td align="center">Master Node</td></tr><tr><td align="center">k8sc01</td><td align="center">192.168.149.134</td><td align="center">ens33</td><td align="center">22</td><td align="center">Ubuntu 20.04.2</td><td align="center">YES</td><td align="center">Compute Node</td></tr><tr><td align="center">k8sc02</td><td align="center">192.168.149.135</td><td align="center">ens33</td><td align="center">22</td><td align="center">Ubuntu 20.04.2</td><td align="center">YES</td><td align="center">Compute Node</td></tr></tbody></table><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>請在 Master Node 擇一節點操作</p><p>下載 DeepOps 軟體包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone --recurse-submodules https://github.com/NVIDIA/deepops.git -b release-20.12</span><br><span class="line">cd deepops</span><br></pre></td></tr></table></figure><p>安裝套件及產生 <code>config</code> 資料夾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -H ./scripts/setup.sh</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/setup.PNG" class="" title="安裝套件"><p>編輯建置設定檔 (ini)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim config/inventory</span><br></pre></td></tr></table></figure><p>將資料輸入之後存檔離開</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[all]</span><br><span class="line">k8sm01 ansible_host&#x3D;192.168.149.128 ansible_port&#x3D;22 ansible_interfaces&#x3D;ens33</span><br><span class="line">k8sm02 ansible_host&#x3D;192.168.149.129 ansible_port&#x3D;22 ansible_interfaces&#x3D;ens33</span><br><span class="line">k8sm03 ansible_host&#x3D;192.168.149.130 ansible_port&#x3D;22 ansible_interfaces&#x3D;ens33</span><br><span class="line">k8sc01 ansible_host&#x3D;192.168.149.134 ansible_port&#x3D;22 ansible_interfaces&#x3D;ens33</span><br><span class="line">k8sc02 ansible_host&#x3D;192.168.149.135 ansible_port&#x3D;22 ansible_interfaces&#x3D;ens33</span><br><span class="line"></span><br><span class="line">######</span><br><span class="line"># KUBERNETES</span><br><span class="line">######</span><br><span class="line">[kube-master]</span><br><span class="line">k8sm01</span><br><span class="line">k8sm02</span><br><span class="line">k8sm03</span><br><span class="line"></span><br><span class="line">[etcd]</span><br><span class="line">k8sm01</span><br><span class="line">k8sm02</span><br><span class="line">k8sm03</span><br><span class="line"></span><br><span class="line">[kube-node]</span><br><span class="line">k8sc01</span><br><span class="line">k8sc02</span><br><span class="line"></span><br><span class="line">[k8s-cluster:children]</span><br><span class="line">kube-master</span><br><span class="line">kube-node</span><br></pre></td></tr></table></figure><h3 id="建置-Master-節點"><a href="#建置-Master-節點" class="headerlink" title="建置 Master 節點"></a>建置 Master 節點</h3><p>佈署管理節點 (Master Nodes)，第一次使用需輸入 ssh(-k) 及 sudo(-K) 密碼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -l kube-master -k -K playbooks/k8s-cluster.yml</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/master.PNG" class="" title="佈署管理節點"><p>運行完成成功畫面，要確認 <code>failed</code> 為 <code>0</code></p><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/master_output.PNG" class="" title="運行完成成功畫面"><p>確認管理節點皆成功建置完成</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/master_nodes.PNG" class="" title="確認管理節點皆成功建置完成"><h3 id="建置-Compute-節點"><a href="#建置-Compute-節點" class="headerlink" title="建置 Compute 節點"></a>建置 Compute 節點</h3><p>佈署計算節點 (Compute Nodes)，第一次使用需輸入 ssh(-k) 及 sudo(-K) 密碼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -l k8s-cluster -k -K playbooks/k8s-cluster.yml</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/compute.PNG" class="" title="佈署計算節點"><p>運行完成成功畫面，要確認 <code>failed</code> 為 <code>0</code></p><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/compute_output.PNG" class="" title="運行完成成功畫面"><p>設定 Compute 節點的 <code>kubernetes.io/role</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label --overwrite nodes k8sc01 kubernetes.io/role=compute</span><br><span class="line">kubectl label --overwrite nodes k8sc02 kubernetes.io/role=compute</span><br></pre></td></tr></table></figure><p>確認計算節點皆成功建置完成</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/10/02/nvidia-deepops/compute_nodes.PNG" class="" title="確認管理節點皆成功建置完成"><hr><h2 id="K8s-維護"><a href="#K8s-維護" class="headerlink" title="K8s 維護"></a>K8s 維護</h2><h3 id="安裝-Kubernetes-Dashboard"><a href="#安裝-Kubernetes-Dashboard" class="headerlink" title="安裝 Kubernetes Dashboard"></a>安裝 Kubernetes Dashboard</h3><p>創建管理用戶並安裝儀錶板和 token，如日後忘記 token ，同指令可再執行一次即可獲得。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/k8s/deploy_dashboard_user.sh</span><br></pre></td></tr></table></figure><ul><li>Dashboard: https://&lt; Master Node IP &gt;:31443</li></ul><h3 id="安裝-Monitoring"><a href="#安裝-Monitoring" class="headerlink" title="安裝 Monitoring"></a>安裝 Monitoring</h3><p>佈署 DCGM、Prometheus 和 Grafana 來監控各節點的資源使用情況</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/k8s/deploy_monitoring.sh</span><br></pre></td></tr></table></figure><ul><li>Grafana: http://&lt; Master Node IP &gt;:30200</li><li>Prometheus: http://&lt; Master Node IP &gt;:30500</li><li>Alertmanager: http://&lt; Master Node IP &gt;:30400</li></ul><h3 id="增加節點"><a href="#增加節點" class="headerlink" title="增加節點"></a>增加節點</h3><p>回到建置設定檔 <code>config/inventory</code>，將新的節點加入後執行以下指令，即可增加節點</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -l k8s-cluster -k -K submodules/kubespray/scale.yml</span><br></pre></td></tr></table></figure><h3 id="移除節點"><a href="#移除節點" class="headerlink" title="移除節點"></a>移除節點</h3><p>將要移除的節點名稱填入，如下範例 (移除 k8sc01 及 k8sc02 兩個節點)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook submodules/kubespray/remove-node.yml --extra-vars "node=k8sc01,k8sc02"</span><br></pre></td></tr></table></figure><h3 id="升級叢集"><a href="#升級叢集" class="headerlink" title="升級叢集"></a>升級叢集</h3><div class="note info">            <p>TODO</p>          </div><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol><li><a href="https://github.com/NVIDIA/deepops" target="_blank" rel="noopener">DeepOps Github</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
            <tag> KUBERNETES </tag>
            
            <tag> DEEPOPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 Proxy 設定</title>
      <link href="2020/10/02/ubuntu-proxy/"/>
      <url>2020/10/02/ubuntu-proxy/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因為常用到，所以特此紀錄方便日後查詢。</p><hr><h2 id="APT-Proxy-設定"><a href="#APT-Proxy-設定" class="headerlink" title="APT Proxy 設定"></a>APT Proxy 設定</h2><h3 id="建立設定檔"><a href="#建立設定檔" class="headerlink" title="建立設定檔"></a>建立設定檔</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/apt.conf.d/proxy.conf</span><br></pre></td></tr></table></figure><h3 id="填入-Porxy-資訊"><a href="#填入-Porxy-資訊" class="headerlink" title="填入 Porxy 資訊"></a>填入 Porxy 資訊</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Acquire::http::Proxy "http://user:password@proxy.server:port/";</span><br><span class="line">Acquire::https::Proxy "https://user:password@proxy.server:port/";</span><br></pre></td></tr></table></figure><h3 id="測試是否成功"><a href="#測試是否成功" class="headerlink" title="測試是否成功"></a>測試是否成功</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure><hr><h2 id="其他軟體-Proxy-設定"><a href="#其他軟體-Proxy-設定" class="headerlink" title="其他軟體 Proxy 設定"></a>其他軟體 Proxy 設定</h2><p>如 <code>git</code>、<code>docker</code>、<code>pip</code>等要走 proxy 了話，就要將 porxy 設定寫入環境變數中，方能生效。</p><h3 id="編輯環境變數檔"><a href="#編輯環境變數檔" class="headerlink" title="編輯環境變數檔"></a>編輯環境變數檔</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="填入-Porxy-資訊-1"><a href="#填入-Porxy-資訊-1" class="headerlink" title="填入 Porxy 資訊"></a>填入 Porxy 資訊</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http_proxy="http://user:password@proxy.server:port/"</span><br><span class="line">https_proxy="https://user:password@proxy.server:port/"</span><br><span class="line">ftp_proxy="ftp://user:password@proxy.server:port/"</span><br><span class="line">no_proxy="localhost,127.0.0.1"</span><br><span class="line"></span><br><span class="line">HTTP_PROXY="http://user:password@proxy.server:port/"</span><br><span class="line">HTTPS_PROXY="https://user:password@proxy.server:port/"</span><br><span class="line">FTP_PROXY="ftp://user:password@proxy.server:port/"</span><br><span class="line">NO_PROXY="localhost,127.0.0.1"</span><br></pre></td></tr></table></figure><h3 id="重啟環境變數"><a href="#重啟環境變數" class="headerlink" title="重啟環境變數"></a>重啟環境變數</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PROXY </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Triton Inference Server 介紹與範例</title>
      <link href="2020/07/20/nvidia-triton-inference-server/"/>
      <url>2020/07/20/nvidia-triton-inference-server/</url>
      
        <content type="html"><![CDATA[<div class="note info">            <p>2021/01/07 軟體版本更新至 v2.6.0</p>          </div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>隨著深度學習技術快速的成長，在應用環境中部署和運行 AI 模型的需求也與日俱增。然而開發一個推論解決方案來部署這些模型是一項艱鉅的任務，延遲、吞吐量、支援多個 AI 框架、並行多個模型、GPU 最佳化 … 等因素，皆是要考慮到的重點，因此如何進行快速部署及管理成為一件複雜卻必須做的事情。</p><p><a href="https://developer.nvidia.com/nvidia-triton-inference-server" target="_blank" rel="noopener">NVIDIA Triton Inference Server</a> 由 NVIDIA 釋出的一套開源軟體 — 模型推論解決方案，具低延遲、高吞吐等特性，可透過 HTTP 或 GRPC 端點提供客戶端推理服務及服務管理，大幅簡化 AI 模型部署的流程。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/triton.png" class="" title="Triton Inference Server 架構"><div class="note info">            <p>由於 Triton 系統龐大再加上篇幅限制，本章注重在基本功能的操作，較深的功能將於日後配合專案來介紹。</p>          </div><hr><h2 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h2><p>Triton 簡單來看走的是 Client-Server 架構。<br>Server 主要功能為傳接資料，並進行推論；而 Client 則為傳接資料，並結合如網頁、手機 APP 等提升使用者體驗。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/sc.png" class="" title="Server、Client 示意圖"><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul><li>支援多種 AI 框架<ul><li>TensorRT (plan)</li><li>ONNX (onnx)</li><li>TorchScript (pt)</li><li>Tensorflow (graphdef, savedmodel)</li></ul></li><li>支援客製化模組<ul><li>Python (py)</li><li>DALI (dali)</li></ul></li><li>可同時運行多個模型</li><li>可將多個模型串接成一個大模型 (Ensemble Model)</li><li>支援 HTTP 和 GRPC 的接口</li><li>支援將模型庫放在 Google Cloud Storage 、 Amazon S3 或 Azure Storage 中</li><li>具自我監控功能，可顯示 GPU 的利用率，服務器的吞吐量，以及服務器延遲等指標</li><li>適用於部署框架 (Kubernetes) </li><li>允許使用自定義後端 (C++ 或 Python)</li></ul><h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><ul><li>2.6.0</li></ul><div class="note warning">            <p>此版是由 ubuntu 18.04 轉 ubuntu 20.04 的第一版，部分功能還在轉換中，如有疑慮可先使用 2.5.0 版。</p>          </div><hr><h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 20.04</li><li>GPU Driver：450.80.02</li><li>Docker：19.03.14</li><li>Docker Image：nvcr.io/nvidia/tritonserver:20.12-py3</li></ul><h3 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h3><h4 id="安裝-Docker"><a href="#安裝-Docker" class="headerlink" title="安裝 Docker"></a>安裝 Docker</h4><p>本篇是將系統架設在 Docker 上，可以參考此<a href="https://roychou121.github.io/2020/07/13/ubuntu-install-docker/">文章</a> 將 Docker 環境建立起來。</p><h4 id="下載映像檔"><a href="#下載映像檔" class="headerlink" title="下載映像檔"></a>下載映像檔</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull nvcr.io/nvidia/tritonserver:20.12-py3</span><br></pre></td></tr></table></figure><h3 id="運行步驟"><a href="#運行步驟" class="headerlink" title="運行步驟"></a>運行步驟</h3><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/server.png" class="" title="Server 流程圖"><h4 id="模型轉換"><a href="#模型轉換" class="headerlink" title="模型轉換"></a>模型轉換</h4><p>系統支援的模型如下，如訓練時所使用的框架非下述所示，則需進行轉換。</p><ul><li>Tensorflow (graphdef, savedmodel)</li><li>TensorRT (plan)</li><li>ONNX (onnx)</li><li>PyTorch (pt)</li></ul><div class="note info">            <p>為了增加系統效能，建議模型都要過 TensorRT 編譯。</p>          </div><h4 id="建立模型庫"><a href="#建立模型庫" class="headerlink" title="建立模型庫"></a>建立模型庫</h4><p>模型庫中保存著多個模型包。<br>每個模型包皆由版本及設定檔所組成，版本建議以自然數依序命名 (Ex. 1,2,3…)。</p><p>建立模型庫範例如下圖所示：<br>以此範例來說<br>模型庫為 <code>model-repository</code><br>模型庫中共存放了4個模型包 (<code>mnistTensorrt</code>, <code>mnist-tftrt</code>, <code>tensorflowGraphdef</code>, <code>tensorflowSavedmodel</code>)<br>其中以 <code>mnist-tftrt</code> 模型包為例，<code>mnist-tftrt</code> 為此模型的命名，資料夾中存放了版本 <code>1</code> 的模型及設定檔。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/repository.png" class="" title="建立模型庫"><h4 id="編輯設定檔"><a href="#編輯設定檔" class="headerlink" title="編輯設定檔"></a>編輯設定檔</h4><p>每個模型包皆須有設定檔，系統會根據設定檔來運行模型，最基本的設定檔由 5 大元素組成：模型名稱、模型框架、最大批次大小、輸入及輸出層的資訊、GPU 實例資訊。</p><p>更詳盡的參數說明可以參考<a href="https://github.com/triton-inference-server/server/blob/master/docs/model_configuration.md" target="_blank" rel="noopener">官方文件</a>。</p><p>編輯設定檔範例如下圖所示：</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/config.png" class="" title="編輯設定檔"><div class="note info">            <p>設定檔中的模型名稱需與資料夾的模型名稱一致。</p>          </div><div class="note info">            <p>最大批次大小為推論批次設定的最大值，不一定是實際推論批次大小。</p>          </div><h4 id="運行伺服器端"><a href="#運行伺服器端" class="headerlink" title="運行伺服器端"></a>運行伺服器端</h4><p>在運行前需指定此服務要跑幾個 GPU、走哪些 Port 以及模型庫的路徑。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --gpus &lt;GPU Number&gt; --name &lt;Conatainer Name&gt; --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p &lt;Host Port&gt;:8000 -p &lt;Host Port&gt;:8001 -p &lt;Host Port&gt;:8002 -v &lt;Model Repository Path&gt;:/models nvcr.io/nvidia/tritonserver:20.12-py3 tritonserver --model-store=/models</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example</span></span><br><span class="line">sudo docker run -d --gpus all --name Triton_Server --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p 8000:8000 -p 8001:8001 -p 8002:8002 -v /home/user/Documents/model-repository:/models nvcr.io/nvidia/tritonserver:20.12-py3 tritonserver --model-store=/models</span><br></pre></td></tr></table></figure><div class="note info">            <p>Port 8000 為 HTTP 協定通道<br>Port 8001 為 GRPC 協定通道</p>          </div><h4 id="檢查系統狀態"><a href="#檢查系統狀態" class="headerlink" title="檢查系統狀態"></a>檢查系統狀態</h4><p>檢查系統是否正常的運行中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v localhost:8000/v2/health/ready</span><br></pre></td></tr></table></figure><p>檢查模型的狀態：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET v2/models[/$&#123;MODEL_NAME&#125;[/versions/$&#123;MODEL_VERSION&#125;]]/stats</span><br></pre></td></tr></table></figure><p>Triton 提供 Prometheus Metrics，內容主要為 GPU 狀態和請求統計資訊等：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8002/metrics</span><br></pre></td></tr></table></figure><hr><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><h3 id="系統環境-1"><a href="#系統環境-1" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 20.04</li><li>Docker：19.03.14</li><li>Docker Image：nvcr.io/nvidia/tritonserver:20.12-py3-sdk</li></ul><h3 id="安裝步驟-1"><a href="#安裝步驟-1" class="headerlink" title="安裝步驟"></a>安裝步驟</h3><h4 id="安裝-Docker-1"><a href="#安裝-Docker-1" class="headerlink" title="安裝 Docker"></a>安裝 Docker</h4><p>本篇是將系統架設在 Docker 上，可以參考此<a href="https://roychou121.github.io/2020/07/13/ubuntu-install-docker/">文章</a> 將 Docker 環境建立起來。</p><h4 id="下載映像檔-1"><a href="#下載映像檔-1" class="headerlink" title="下載映像檔"></a>下載映像檔</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull nvcr.io/nvidia/tritonserver:20.12-py3-sdk</span><br></pre></td></tr></table></figure><h3 id="運行步驟-1"><a href="#運行步驟-1" class="headerlink" title="運行步驟"></a>運行步驟</h3><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/client.png" class="" title="Client 流程圖"><h4 id="串接設備"><a href="#串接設備" class="headerlink" title="串接設備"></a>串接設備</h4><p>目前主流要推論的資料為數據、影像、聲音以及文字，在跟 Server 端溝通之前，Client 端需先跟各設備進行串接。</p><p>如影像型推論，就需跟攝影機、機台、儲存設備、呈現平台…等串接。</p><h4 id="撰寫程式碼"><a href="#撰寫程式碼" class="headerlink" title="撰寫程式碼"></a>撰寫程式碼</h4><p>Client 端程式碼撰寫主要分成三大部分，依序為</p><ul><li>前處理<br>此部分主要處裡的事項為資訊進模型前的所有處理，如影像解碼、維度轉換、訊號處理等等。</li><li>Client-Server 溝通<br>指定將推論的模型資訊，透過 HTTP 或 GRPC 跟 Server 溝通。<br>官方範例可以參考<a href="https://github.com/triton-inference-server/server/tree/master/src/clients/python/examples" target="_blank" rel="noopener">官方範例</a>。</li><li>後處理<br>此部分主要處裡的事項為接到 Server 回傳來推論結果後的所有處理，如儲存檔案、訊息整理、結果呈現等等。</li></ul><div class="note info">            <p>前後處理會因不同的應用實例有所差異，此部分不是本章的重點。<br>本章將會著重在說明 Triton Client-Server 基本的溝通函數，其他更深入的函數將在日後介紹。</p>          </div><h4 id="運行客戶端"><a href="#運行客戶端" class="headerlink" title="運行客戶端"></a>運行客戶端</h4><p>在運行前需確認 Server 的 IP、走的協定 (HTTP or GRPC) 以及讀取儲存資料的位置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name &lt;Container Name&gt; -v &lt;Data Path&gt;:/data nvcr.io/nvidia/tritonserver:20.12-py3-sdk bash -c '&lt;Client Code&gt;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example</span></span><br><span class="line">sudo docker run -d --name Triton_Client -v /home/user/Documents/data:/data nvcr.io/nvidia/tritonserver:20.12-py3-sdk bash -c 'python /data/client.py'</span><br></pre></td></tr></table></figure><hr><h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>接下來將以大家耳熟能詳的 <a href="https://www.tensorflow.org/quantum/tutorials/mnist" target="_blank" rel="noopener">MNIST</a> 所訓練出的模型當作範例，由於訓練模型不是本篇的重點，可以直接下載訓練好的模型進行後續的練習。</p><h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><h4 id="訓練模型"><a href="#訓練模型" class="headerlink" title="訓練模型"></a>訓練模型</h4><p>此部分以 MNIST 資料集和簡單的 CNN 模型當作範例。<br>撰寫框架為 TensorFlow v2，來源為<a href="https://www.tensorflow.org/datasets/keras_example" target="_blank" rel="noopener">官方範本</a>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow.compat.v2 <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line"></span><br><span class="line">tf.enable_v2_behavior()</span><br><span class="line"></span><br><span class="line">(ds_train, ds_test), ds_info = tfds.load(</span><br><span class="line">    <span class="string">'mnist'</span>,</span><br><span class="line">    split=[<span class="string">'train'</span>, <span class="string">'test'</span>],</span><br><span class="line">    shuffle_files=<span class="literal">True</span>,</span><br><span class="line">    as_supervised=<span class="literal">True</span>,</span><br><span class="line">    with_info=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_img</span><span class="params">(image, label)</span>:</span></span><br><span class="line">  <span class="string">"""Normalizes images: `uint8` -&gt; `float32`."""</span></span><br><span class="line">  <span class="keyword">return</span> tf.cast(image, tf.float32) / <span class="number">255.</span>, label</span><br><span class="line"></span><br><span class="line">ds_train = ds_train.map(</span><br><span class="line">    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">ds_train = ds_train.cache()</span><br><span class="line">ds_train = ds_train.shuffle(ds_info.splits[<span class="string">'train'</span>].num_examples)</span><br><span class="line">ds_train = ds_train.batch(<span class="number">128</span>)</span><br><span class="line">ds_train = ds_train.prefetch(tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ds_test = ds_test.map(</span><br><span class="line">    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">ds_test = ds_test.batch(<span class="number">128</span>)</span><br><span class="line">ds_test = ds_test.cache()</span><br><span class="line">ds_test = ds_test.prefetch(tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model = tf.keras.models.Sequential([</span><br><span class="line">  tf.keras.layers.Flatten(input_shape=(<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)),</span><br><span class="line">  tf.keras.layers.Dense(<span class="number">128</span>,activation=<span class="string">'relu'</span>),</span><br><span class="line">  tf.keras.layers.Dense(<span class="number">10</span>)</span><br><span class="line">])</span><br><span class="line">model.compile(</span><br><span class="line">    optimizer=tf.keras.optimizers.Adam(<span class="number">0.001</span>),</span><br><span class="line">    loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="literal">True</span>),</span><br><span class="line">    metrics=[tf.keras.metrics.SparseCategoricalAccuracy()],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model.fit(</span><br><span class="line">    ds_train,</span><br><span class="line">    epochs=<span class="number">6</span>,</span><br><span class="line">    validation_data=ds_test,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 模型儲存</span></span><br><span class="line">model.save(<span class="string">'model.savedmodel'</span>)</span><br></pre></td></tr></table></figure><h4 id="建立模型庫-1"><a href="#建立模型庫-1" class="headerlink" title="建立模型庫"></a>建立模型庫</h4><p>以上面的模型為例，建立出的模型庫如下圖所示。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/repository_ex.PNG" class="" title="建立模型庫"><h4 id="編輯設定檔-1"><a href="#編輯設定檔-1" class="headerlink" title="編輯設定檔"></a>編輯設定檔</h4><p>以下的參數為必要欄位，其他深入或客製化的參數，可以參考<a href="https://github.com/triton-inference-server/server/blob/master/docs/model_configuration.md" target="_blank" rel="noopener">官網文件</a>。</p><div class="note info">            <p>使用 <code>gpu_execution_accelerator</code> 可在運行 Triton 時，轉成 TensorRT 來加速。<br>只支援 TensorFlow、ONNX。</p>          </div><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="string">"mnist"</span></span><br><span class="line">platform: <span class="string">"tensorflow_savedmodel"</span></span><br><span class="line">max_batch_size: <span class="number">32</span></span><br><span class="line">input [</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">"flatten_input"</span></span><br><span class="line">        data_type: TYPE_FP32</span><br><span class="line">        format: FORMAT_NHWC</span><br><span class="line">        dims: [<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">output [</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">"dense_1"</span></span><br><span class="line">        data_type: TYPE_FP32</span><br><span class="line">        dims: [<span class="number">10</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">instance_group [</span><br><span class="line">    &#123;</span><br><span class="line">        kind: KIND_GPU</span><br><span class="line">        count: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">optimization &#123; execution_accelerators &#123;</span><br><span class="line">    gpu_execution_accelerator : [ &#123;</span><br><span class="line">        name : <span class="string">"tensorrt"</span></span><br><span class="line">        parameters &#123; key: <span class="string">"precision_mode"</span> value: <span class="string">"FP16"</span> &#125;&#125;]</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">version_policy &#123; latest &#123; num_versions: <span class="number">1</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line">dynamic_batching &#123;</span><br><span class="line">  preferred_batch_size: [ <span class="number">4</span>, <span class="number">8</span> ]</span><br><span class="line">  max_queue_delay_microseconds: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="運行伺服器端-1"><a href="#運行伺服器端-1" class="headerlink" title="運行伺服器端"></a>運行伺服器端</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --gpus all --name Triton_Server --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p 8000:8000 -p 8001:8001 -p 8002:8002 -v /home/user/Documents/model-repository:/models nvcr.io/nvidia/tritonserver:20.12-py3 tritonserver --model-store=/models --backend-config=tensorflow,version=2 --backend-config=tensorflow,allow-soft-placement=0</span><br></pre></td></tr></table></figure><p>運行伺服器端後，成功的畫面如下所示。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/runServer.PNG" class="" title="運行伺服器端成功畫面"><h4 id="檢查系統狀態-1"><a href="#檢查系統狀態-1" class="headerlink" title="檢查系統狀態"></a>檢查系統狀態</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v localhost:8000/v2/health/ready</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/healthReady.PNG" class="" title="health ready 畫面"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8000/v2/models/mnist/versions/1/stats</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/stats.PNG" class="" title="模型狀態"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8002/metrics</span><br></pre></td></tr></table></figure><p>部分 Metrics 畫面：</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/metrics.PNG" class="" title="部分 metrics 畫面"><h3 id="Cleint"><a href="#Cleint" class="headerlink" title="Cleint"></a>Cleint</h3><h4 id="串接設備-1"><a href="#串接設備-1" class="headerlink" title="串接設備"></a>串接設備</h4><p>由於沒有實際的設備可以串接，此部分直接取用 MNIST 測試資料集中一張影像當作範例，最後將接到的推論結果直接顯示在螢幕上。</p><p>MNIST 測試資料如下圖所示。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/input.jpg" class="" title="測試資料"><h4 id="撰寫程式碼-1"><a href="#撰寫程式碼-1" class="headerlink" title="撰寫程式碼"></a>撰寫程式碼</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tritonclient.grpc <span class="keyword">as</span> grpcclient</span><br><span class="line"><span class="keyword">from</span> tritonclient.utils <span class="keyword">import</span> triton_to_np_dtype</span><br><span class="line"></span><br><span class="line"><span class="comment">## 前處理</span></span><br><span class="line">img = Image.open(<span class="string">'input.jpg'</span>).convert(<span class="string">'L'</span>)</span><br><span class="line">img = img.resize((<span class="number">28</span>, <span class="number">28</span>))</span><br><span class="line">imgArr = np.asarray(img)/<span class="number">255</span></span><br><span class="line">imgArr = np.expand_dims(imgArr[:, :, np.newaxis], <span class="number">0</span>)</span><br><span class="line">imgArr= imgArr.astype(triton_to_np_dtype(<span class="string">'FP32'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Client-Server 溝通</span></span><br><span class="line">triton_client = grpcclient.InferenceServerClient(url=<span class="string">'localhost:8001'</span>, verbose=<span class="number">0</span>)</span><br><span class="line">inputs = []</span><br><span class="line">inputs.append(grpcclient.InferInput(<span class="string">'flatten_input'</span>, imgArr.shape, <span class="string">'FP32'</span>))</span><br><span class="line">inputs[<span class="number">0</span>].set_data_from_numpy(imgArr)</span><br><span class="line">outputs = []</span><br><span class="line">outputs.append(grpcclient.InferRequestedOutput(<span class="string">'dense_1'</span>,class_count=<span class="number">0</span>))</span><br><span class="line">responses = []</span><br><span class="line">responses.append(triton_client.infer(<span class="string">'mnist'</span>,inputs,</span><br><span class="line">                    request_id=str(<span class="number">1</span>),</span><br><span class="line">                    model_version=<span class="string">'1'</span>,</span><br><span class="line">                    outputs=outputs))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 後處理</span></span><br><span class="line"><span class="keyword">print</span> (np.argmax(responses[<span class="number">0</span>].as_numpy(<span class="string">'dense_1'</span>)[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure><h4 id="運行客戶端-1"><a href="#運行客戶端-1" class="headerlink" title="運行客戶端"></a>運行客戶端</h4><p>將客戶端環境運行起來後，執行上部撰寫好的程式碼，即可進行推論。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --name Triton_Client -v /home/user/data:/data nvcr.io/nvidia/tritonserver:20.12-py3-sdk bash -c 'python /data/client.py'</span><br></pre></td></tr></table></figure><p>最後 MNIST 推論結果如下圖所示，可以發現有成功的預測出數字。</p><img src= "/img/loading.gif" data-src="/2020/07/20/nvidia-triton-inference-server/result.PNG" class="" title="結果"><hr><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol><li><a href="https://developer.nvidia.com/nvidia-triton-inference-server" target="_blank" rel="noopener">Triton Inference Server</a></li><li><a href="https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/index.html" target="_blank" rel="noopener">Triton Inference Server Documentation</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> Inference </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
            <tag> INFERENCE </tag>
            
            <tag> SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 安裝 Anaconda3</title>
      <link href="2020/07/20/ubuntu-install-anaconda/"/>
      <url>2020/07/20/ubuntu-install-anaconda/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如何在 Ubuntu 18.04 上安裝 Anaconda3 ?</p><hr><h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>Python：3.7.6</li><li>Anaconda3：2020.02</li></ul><h3 id="步驟"><a href="#步驟" class="headerlink" title="步驟"></a>步驟</h3><h4 id="安裝使用工具-選"><a href="#安裝使用工具-選" class="headerlink" title="安裝使用工具 (選)"></a>安裝使用工具 (選)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install vim wget</span><br></pre></td></tr></table></figure><h4 id="下載-Anaconda3"><a href="#下載-Anaconda3" class="headerlink" title="下載 Anaconda3"></a>下載 <code>Anaconda3</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.anaconda.com/archive/Anaconda3-2020.02-Linux-x86_64.sh</span><br></pre></td></tr></table></figure><h4 id="執行安裝檔"><a href="#執行安裝檔" class="headerlink" title="執行安裝檔"></a>執行安裝檔</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash Anaconda3-2020.02-Linux-x86_64.sh</span><br></pre></td></tr></table></figure><h4 id="閱讀-License"><a href="#閱讀-License" class="headerlink" title="閱讀 License"></a>閱讀 License</h4><p>一開始會跑出 license，按 <code>Enter</code> 看完</p><img src= "/img/loading.gif" data-src="/2020/07/20/ubuntu-install-anaconda/license.PNG" class="" title="閱讀 license"><h4 id="同意-License"><a href="#同意-License" class="headerlink" title="同意 License"></a>同意 License</h4><p>輸入 <code>yes</code> 同意並繼續</p><img src= "/img/loading.gif" data-src="/2020/07/20/ubuntu-install-anaconda/accept.PNG" class="" title="同意 license"><h4 id="儲存路徑"><a href="#儲存路徑" class="headerlink" title="儲存路徑"></a>儲存路徑</h4><p>如果不改變位置，輸入 <code>Enter</code> 繼續執行</p><img src= "/img/loading.gif" data-src="/2020/07/20/ubuntu-install-anaconda/path.PNG" class="" title="儲存路徑"><h4 id="加入環境變數"><a href="#加入環境變數" class="headerlink" title="加入環境變數"></a>加入環境變數</h4><p>輸入 <code>yes</code> ，把 anaconda 加入環境變數</p><img src= "/img/loading.gif" data-src="/2020/07/20/ubuntu-install-anaconda/bashrc.PNG" class="" title="加入環境變數"><h4 id="修改權限"><a href="#修改權限" class="headerlink" title="修改權限"></a>修改權限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $USER:$USER ~/anaconda3</span><br></pre></td></tr></table></figure><h4 id="重啟環境變數"><a href="#重啟環境變數" class="headerlink" title="重啟環境變數"></a>重啟環境變數</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h4 id="檢查-Anaconda-是否安裝成功"><a href="#檢查-Anaconda-是否安裝成功" class="headerlink" title="檢查 Anaconda 是否安裝成功"></a>檢查 Anaconda 是否安裝成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/20/ubuntu-install-anaconda/python.PNG" class="" title="檢查 Anaconda 是否安裝成功">]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Anaconda </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 設定 DNS</title>
      <link href="2020/07/15/ubuntu-dns/"/>
      <url>2020/07/15/ubuntu-dns/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 Ubuntu 16.04 以上的作業系統，有時候會發生 DNS 跑掉的情況，而從<code>/etc/resolv.conf</code>更改後，雖可以正常使用，但重開機後又回跳回原本的設定，原因是因為此檔案會被 <code>systemd-resolvd</code>自動修改，所以本篇將介紹兩種正確的設定 DNS 的方式。</p><hr><h2 id="方法一：修改-systemd-resolv"><a href="#方法一：修改-systemd-resolv" class="headerlink" title="方法一：修改 systemd-resolv"></a>方法一：修改 <code>systemd-resolv</code></h2><h3 id="編輯-resolved-conf"><a href="#編輯-resolved-conf" class="headerlink" title="編輯 resolved.conf"></a>編輯 <code>resolved.conf</code></h3><p>編輯 <code>/etc/systemd/resolved.conf</code>，在 <code>DNS=</code>欄位中輸入慣用的 dns server</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/systemd/resolved.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Resolve]</span><br><span class="line">DNS&#x3D;8.8.8.8 8.8.4.4</span><br><span class="line">#FallbackDNS&#x3D;</span><br><span class="line">#Domains&#x3D;</span><br><span class="line">LLMNR&#x3D;no</span><br><span class="line">#MulticastDNS&#x3D;no</span><br><span class="line">#DNSSEC&#x3D;no</span><br><span class="line">#Cache&#x3D;yes</span><br><span class="line">#DNSStubListener&#x3D;yes</span><br></pre></td></tr></table></figure><h3 id="重啟服務"><a href="#重啟服務" class="headerlink" title="重啟服務"></a>重啟服務</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart systemd-networkd</span><br><span class="line">sudo systemctl restart systemd-resolved</span><br></pre></td></tr></table></figure><hr><h2 id="方法二：使用-resolvconf-軟體"><a href="#方法二：使用-resolvconf-軟體" class="headerlink" title="方法二：使用 resolvconf 軟體"></a>方法二：使用 <code>resolvconf</code> 軟體</h2><h3 id="下載套件"><a href="#下載套件" class="headerlink" title="下載套件"></a>下載套件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install resolvconf</span><br></pre></td></tr></table></figure><h3 id="編輯-head"><a href="#編輯-head" class="headerlink" title="編輯 head"></a>編輯 <code>head</code></h3><p>編輯 <code>/etc/resolvconf/resolv.conf.d/head</code>，輸入慣用的 dns server</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/resolvconf/resolv.conf.d/head</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure><h3 id="重啟服務-1"><a href="#重啟服務-1" class="headerlink" title="重啟服務"></a>重啟服務</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service resolvconf restart</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>針對已啟用 Docker Container 修改 Port</title>
      <link href="2020/07/15/docker-container-change-port/"/>
      <url>2020/07/15/docker-container-change-port/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>假如某一天，你突然想改變 port 的對應或者是新增或移除 port ，該怎麼做呢？</p><div class="note warning">            <p>理論上 Container 為一次性的概念，所以當要改設定時，建議建立新的 Container 較為恰當。</p>          </div><hr><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="方法一：重建-Container"><a href="#方法一：重建-Container" class="headerlink" title="方法一：重建 Container"></a>方法一：重建 Container</h3><p>如前言所說，這是推薦方法。</p><h4 id="停止要修改的-Container"><a href="#停止要修改的-Container" class="headerlink" title="停止要修改的 Container"></a>停止要修改的 Container</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><h4 id="把-Container-建成-Image"><a href="#把-Container-建成-Image" class="headerlink" title="把 Container 建成 Image"></a>把 Container 建成 Image</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit &lt;Container ID or Name&gt; &lt;Image ID&gt;</span><br></pre></td></tr></table></figure><h4 id="把剛剛創的-Image-重新建立新的-Container-並指定所需的-Port"><a href="#把剛剛創的-Image-重新建立新的-Container-並指定所需的-Port" class="headerlink" title="把剛剛創的 Image 重新建立新的 Container 並指定所需的 Port"></a>把剛剛創的 Image 重新建立新的 Container 並指定所需的 Port</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --name &lt;Container Name&gt; -p &lt;Host&gt;:&lt;Container&gt; &lt;Image ID&gt; bash</span><br></pre></td></tr></table></figure><h3 id="方法二：修改-Container"><a href="#方法二：修改-Container" class="headerlink" title="方法二：修改 Container"></a>方法二：修改 Container</h3><h4 id="停止要修改的-Container-1"><a href="#停止要修改的-Container-1" class="headerlink" title="停止要修改的 Container"></a>停止要修改的 Container</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><h4 id="進入-root-帳號"><a href="#進入-root-帳號" class="headerlink" title="進入 root 帳號"></a>進入 root 帳號</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su -</span><br></pre></td></tr></table></figure><h4 id="修改-Container-的設定檔-hostconfig-json"><a href="#修改-Container-的設定檔-hostconfig-json" class="headerlink" title="修改 Container 的設定檔 hostconfig.json"></a>修改 Container 的設定檔 <code>hostconfig.json</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/docker/containers/&lt;Container ID&gt;/hostconfig.json</span><br></pre></td></tr></table></figure><p>假設原本的 port 對應為 9453 → 22</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"PortBindings"</span>: &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="attr">"HostIp"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"HostPort"</span>: <span class="string">"9453"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改成 8888 → 22 ，其他以此類推</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"PortBindings"</span>: &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="attr">"HostIp"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"HostPort"</span>: <span class="string">"8888"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改-Container-的設定檔-config-v2-json"><a href="#修改-Container-的設定檔-config-v2-json" class="headerlink" title="修改 Container 的設定檔 config.v2.json"></a>修改 Container 的設定檔 <code>config.v2.json</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/docker/containers/&lt;Container ID&gt;/config.v2.json</span><br></pre></td></tr></table></figure><p>假設原本的 port 對應為 9453 → 22</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ExposedPorts"</span> : &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>:&#123;&#125;,<span class="attr">"9453/tcp"</span>:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"Ports"</span> : &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>:[&#123;<span class="attr">"HostIp"</span>:<span class="string">"0.0.0.0"</span>,<span class="attr">"HostPort"</span>:<span class="string">"9453"</span>&#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改成 8888 → 22 ，其他以此類推</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ExposedPorts"</span> : &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>:&#123;&#125;,<span class="attr">"8888/tcp"</span>:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"Ports"</span> : &#123;</span><br><span class="line">        <span class="attr">"22/tcp"</span>:[&#123;<span class="attr">"HostIp"</span>:<span class="string">"0.0.0.0"</span>,<span class="attr">"HostPort"</span>:<span class="string">"8888"</span>&#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="重啟-Docker-Engine"><a href="#重啟-Docker-Engine" class="headerlink" title="重啟 Docker Engine"></a>重啟 Docker Engine</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker restart</span><br></pre></td></tr></table></figure><h4 id="離開-root-帳號及重新啟動-Container"><a href="#離開-root-帳號及重新啟動-Container" class="headerlink" title="離開 root 帳號及重新啟動 Container"></a>離開 root 帳號及重新啟動 Container</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">sudo docker start &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DOCKER </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jupyter Notebook 增加密碼保護</title>
      <link href="2020/07/15/jupyter-password/"/>
      <url>2020/07/15/jupyter-password/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果你不要每次執行 <code>jupyter lab</code> 時都要打 <code>token</code> ，那就自己設個密碼吧。</p><hr><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="產生設定檔"><a href="#產生設定檔" class="headerlink" title="產生設定檔"></a>產生設定檔</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --generate-config</span><br></pre></td></tr></table></figure><h3 id="設定密碼"><a href="#設定密碼" class="headerlink" title="設定密碼"></a>設定密碼</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter-notebook password</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JUPYTER </tag>
            
            <tag> PYTHON </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>查詢日本景點的 Mapcode</title>
      <link href="2020/07/15/mapcode/"/>
      <url>2020/07/15/mapcode/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每年都會到日本玩的人越來越多，自駕的也不在少數。但如果有自駕過的人就會知道，因為語言不同，在輸入導航時常常要查很久，甚至有時候連輸入都不會。還好日本導航系統很完整，除了可以輸入電話之外，也可以使用日本獨有地圖資料系統 MapCode (マップコード)。</p><p><a href="https://www.mapion.co.jp/" target="_blank" rel="noopener">MapCode</a> 透過將地圖不斷細分劃格的方式，藉此標示出地點的詳細位置資訊，共由 9 ~ 10 個數字所組成。可以在導航前，事先在家裡在官網上輸入地址，查好景點的 Mapcode 。但是有用過的就會發現，日本的地址不太會打，外加輸入繁體字常常會搜尋不到，所以本文章使用大家熟悉的 google map 來做轉換。透過 google api 把地址轉換成經緯度，再利用爬蟲將經緯度轉換成 mapcode 。</p><hr><h2 id="功能說明"><a href="#功能說明" class="headerlink" title="功能說明"></a>功能說明</h2><h3 id="TransLatLng"><a href="#TransLatLng" class="headerlink" title="TransLatLng"></a><code>TransLatLng</code></h3><p>將查詢的地址轉換成經緯度，解碼器由 google 提供，如需大量使用請改使用<a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank" rel="noopener">Google Maps API</a>，預設地址為<code>東京</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TransLatLng</span><span class="params">(self, query=<span class="string">'東京'</span>)</span>:</span></span><br><span class="line">    self.LocationParams = &#123;<span class="string">'address'</span>: query&#125;</span><br><span class="line">    r = requests.get(self.LocationURL, params = self.LocationParams)</span><br><span class="line">    responseJson = json.loads(r.text)</span><br><span class="line">    lat = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'geometry'</span>][<span class="string">'location'</span>][<span class="string">'lat'</span>]</span><br><span class="line">    lng = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'geometry'</span>][<span class="string">'location'</span>][<span class="string">'lng'</span>]</span><br><span class="line">    address = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'formatted_address'</span>]</span><br><span class="line">    <span class="keyword">return</span> [lat, lng, address]</span><br></pre></td></tr></table></figure><p>範例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mapcode</span><br><span class="line"></span><br><span class="line">example = mapcode.Mapcode()</span><br><span class="line"><span class="keyword">print</span> (example.TransLatLng(<span class="string">'福岡塔'</span>))</span><br></pre></td></tr></table></figure><p>輸出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># [緯度, 經度, 地址]</span></span><br><span class="line">[<span class="number">33.5932642</span>, <span class="number">130.3515144</span>, <span class="string">'2 Chome-3-２６ Momochihama, Sawara Ward, Fukuoka, Fukuoka Prefecture 814-0001, Japan'</span>]</span><br></pre></td></tr></table></figure><h3 id="TransMapcode"><a href="#TransMapcode" class="headerlink" title="TransMapcode"></a><code>TransMapcode</code></h3><p>將經緯度轉換成 mapcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">TransMapcode</span><span class="params">(self, lat, lon)</span>:</span></span><br><span class="line">    self.MapcodeParams = &#123;<span class="string">'address'</span>: <span class="string">''</span>, <span class="string">'lat'</span>: lat, <span class="string">'lon'</span> : lon, <span class="string">'scl'</span> : <span class="number">16</span>, <span class="string">'layer'</span> : <span class="string">''</span>&#125;</span><br><span class="line">    r = requests.get(self.MapcodeURL, params = self.MapcodeParams)</span><br><span class="line">    soup = BeautifulSoup(r.text, <span class="string">"html.parser"</span>)</span><br><span class="line">    mapcode = soup.find(<span class="string">'input'</span>, attrs=&#123;<span class="string">'id'</span>:<span class="string">'find'</span>, <span class="string">'name'</span>:<span class="string">'find'</span>, <span class="string">'type'</span>:<span class="string">'text'</span>&#125;)[<span class="string">'value'</span>]</span><br><span class="line">    <span class="keyword">return</span> mapcode</span><br></pre></td></tr></table></figure><p>範例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mapcode</span><br><span class="line"></span><br><span class="line">example = mapcode.Mapcode()</span><br><span class="line"><span class="keyword">print</span> (example.TransMapcode(<span class="number">33.5932642</span>, <span class="number">130.3515144</span>))</span><br></pre></td></tr></table></figure><p>輸出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span> <span class="number">312</span> <span class="number">703</span>*<span class="number">43</span></span><br></pre></td></tr></table></figure><hr><h2 id="完整程式碼"><a href="#完整程式碼" class="headerlink" title="完整程式碼"></a>完整程式碼</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mapcode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.LocationParams = &#123;<span class="string">'address'</span>: <span class="string">'東京'</span>&#125;</span><br><span class="line">        self.LocationURL = <span class="string">'http://maps.googleapis.com/maps/api/geocode/json'</span></span><br><span class="line">        self.NameURL = <span class="string">'https://www.mapion.co.jp/m2/'</span></span><br><span class="line">        self.MapcodeParams = &#123;<span class="string">'address'</span>: <span class="string">'東京都文京区関口１丁目'</span>, <span class="string">'lat'</span>: <span class="string">'35.7090259'</span>, <span class="string">'lon'</span> : <span class="string">'139.7319925'</span>, <span class="string">'scl'</span> : <span class="number">16</span>, <span class="string">'layer'</span> : <span class="string">''</span>&#125;</span><br><span class="line">        self.MapcodeURL = <span class="string">'https://www.mapion.co.jp/f/mmail/send_mobile/SendMobile_map.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">TransLatLng</span><span class="params">(self, query=<span class="string">'東京'</span>)</span>:</span></span><br><span class="line">        self.LocationParams = &#123;<span class="string">'address'</span>: query&#125;</span><br><span class="line">        r = requests.get(self.LocationURL, params = self.LocationParams)</span><br><span class="line">        responseJson = json.loads(r.text)</span><br><span class="line">        lat = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'geometry'</span>][<span class="string">'location'</span>][<span class="string">'lat'</span>]</span><br><span class="line">        lng = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'geometry'</span>][<span class="string">'location'</span>][<span class="string">'lng'</span>]</span><br><span class="line">        address = responseJson.get(<span class="string">'results'</span>)[<span class="number">0</span>][<span class="string">'formatted_address'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># r = requests.get(self.NameURL + str(lat) + ',' + str(lng) + ',16')</span></span><br><span class="line">        <span class="comment"># soup = BeautifulSoup(r.text, "html.parser")</span></span><br><span class="line">        <span class="comment"># data = soup.find('meta', attrs=&#123;'name':'Keywords'&#125;)['content'].split(',')</span></span><br><span class="line">        <span class="comment"># address = data[0]</span></span><br><span class="line">        <span class="comment"># return [lat, lng, address, place]</span></span><br><span class="line">        <span class="keyword">return</span> [lat, lng, address]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">TransMapcode</span><span class="params">(self, lat, lon)</span>:</span></span><br><span class="line">        self.MapcodeParams = &#123;<span class="string">'address'</span>: <span class="string">''</span>, <span class="string">'lat'</span>: lat, <span class="string">'lon'</span> : lon, <span class="string">'scl'</span> : <span class="number">16</span>, <span class="string">'layer'</span> : <span class="string">''</span>&#125;</span><br><span class="line">        r = requests.get(self.MapcodeURL, params = self.MapcodeParams)</span><br><span class="line">        soup = BeautifulSoup(r.text, <span class="string">"html.parser"</span>)</span><br><span class="line">        mapcode = soup.find(<span class="string">'input'</span>, attrs=&#123;<span class="string">'id'</span>:<span class="string">'find'</span>, <span class="string">'name'</span>:<span class="string">'find'</span>, <span class="string">'type'</span>:<span class="string">'text'</span>&#125;)[<span class="string">'value'</span>]</span><br><span class="line">        <span class="keyword">return</span> mapcode</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PYTHON </tag>
            
            <tag> MAPCODE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NFS 架設</title>
      <link href="2020/07/14/nfs/"/>
      <url>2020/07/14/nfs/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Network FileSystem (NFS) 稱為網路文件系統，是一種分佈式文件系統協定，允許在伺服器上安裝遠端目錄，讓使用者可以管理不同位置的儲存空間。</p><div class="note info">            <p>NFS Server 需要先查詢硬碟狀態，確認是可被掛載的，如果是新硬碟，可參考<a href="https://roychou121.github.io/2020/07/14/ubuntu-disk-partition/">此篇</a>設定。</p>          </div><hr><h2 id="NFS-Server"><a href="#NFS-Server" class="headerlink" title="NFS Server"></a>NFS Server</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>nfs-kernel-server：1.3.4</li></ul><h3 id="安裝-nfs-kernel-server"><a href="#安裝-nfs-kernel-server" class="headerlink" title="安裝 nfs-kernel-server"></a>安裝 <code>nfs-kernel-server</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nfs-kernel-server</span><br></pre></td></tr></table></figure><h3 id="修改-etc-hosts-deny-設定阻擋權限"><a href="#修改-etc-hosts-deny-設定阻擋權限" class="headerlink" title="修改 /etc/hosts.deny 設定阻擋權限"></a>修改 <code>/etc/hosts.deny</code> 設定阻擋權限</h3><p>下面範例是禁止任何主機能和你的 NFS 伺服器進行連接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts.deny</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">portmap:ALL </span><br><span class="line">lockd:ALL </span><br><span class="line">mountd:ALL</span><br><span class="line">rquotad:ALL </span><br><span class="line">statd:ALL</span><br></pre></td></tr></table></figure><h3 id="修改-etc-hosts-allow-設定允許權限"><a href="#修改-etc-hosts-allow-設定允許權限" class="headerlink" title="修改 /etc/hosts.allow 設定允許權限"></a>修改 <code>/etc/hosts.allow</code> 設定允許權限</h3><p>下面範例是允許 <code>192.168.0.*</code> 的主機和你的 NFS 伺服器建立連接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/hosts.allow</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">portmap: 192.168.0.</span><br><span class="line">lockd: 192.168.0.</span><br><span class="line">rquotad: 192.168.0.</span><br><span class="line">mountd: 192.168.0.</span><br><span class="line">statd: 192.168.0.</span><br></pre></td></tr></table></figure><h3 id="修改-etc-exports-設定-NFS-掛載目錄及權限"><a href="#修改-etc-exports-設定-NFS-掛載目錄及權限" class="headerlink" title="修改 /etc/exports 設定 NFS 掛載目錄及權限"></a>修改 <code>/etc/exports</code> 設定 NFS 掛載目錄及權限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;raid 192.168.0.*(rw,sync,no_root_squash,no_subtree_check)</span><br></pre></td></tr></table></figure><ul><li><code>203.68.230.*</code> ：允許連線的IP， * 代表任意值</li><li><code>rw</code>：可讀寫</li><li><code>sync</code>：同步寫入記憶體和硬碟</li><li><code>no_root_squash</code>：用戶進入後即變為 root</li></ul><h3 id="更新並重啟-NFS-服務"><a href="#更新並重啟-NFS-服務" class="headerlink" title="更新並重啟 NFS 服務"></a>更新並重啟 NFS 服務</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo exportfs -arv</span><br><span class="line">sudo service nfs-kernel-server restart</span><br></pre></td></tr></table></figure><hr><h2 id="NFS-Client"><a href="#NFS-Client" class="headerlink" title="NFS Client"></a>NFS Client</h2><h3 id="系統環境-1"><a href="#系統環境-1" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>nfs-common：1.3.4</li></ul><h3 id="安裝-nfs-common"><a href="#安裝-nfs-common" class="headerlink" title="安裝 nfs-common"></a>安裝 <code>nfs-common</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nfs-common</span><br></pre></td></tr></table></figure><h3 id="建立資料夾"><a href="#建立資料夾" class="headerlink" title="建立資料夾"></a>建立資料夾</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /data</span><br></pre></td></tr></table></figure><h3 id="掛載-NFS-Server-的資料夾"><a href="#掛載-NFS-Server-的資料夾" class="headerlink" title="掛載 NFS Server 的資料夾"></a>掛載 NFS Server 的資料夾</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount 192.168.0.100:/raid /data</span><br></pre></td></tr></table></figure><ul><li><code>192.168.0.10</code> ：NFS Server 的 IP</li><li><code>/raid</code>：Server 的資料夾</li><li><code>/data</code>：Client 的資料夾</li></ul><h3 id="寫入-etc-fstab"><a href="#寫入-etc-fstab" class="headerlink" title="寫入 /etc/fstab"></a>寫入 <code>/etc/fstab</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fstab</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.100:&#x2F;raid &#x2F;data nfs defaults 0 0</span><br></pre></td></tr></table></figure><h3 id="重啟掛載表"><a href="#重啟掛載表" class="headerlink" title="重啟掛載表"></a>重啟掛載表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 新增硬碟磁區</title>
      <link href="2020/07/14/ubuntu-disk-partition/"/>
      <url>2020/07/14/ubuntu-disk-partition/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Linux 中的 Parted 是一個用來管理磁碟分割區的工具，舉凡磁碟分割區的新增、刪除、大小變更等動作都可以用這個工具來處理。</p><div class="note warning">            <p><code>fdisk</code> 所能處理的磁碟容量上限是 2TB，若磁碟的容量大於 2TB 就無法使用。</p>          </div><hr><h2 id="操作步驟"><a href="#操作步驟" class="headerlink" title="操作步驟"></a>操作步驟</h2><p>一個完整從新硬碟到掛載磁區的步驟。</p><h3 id="安裝套件"><a href="#安裝套件" class="headerlink" title="安裝套件"></a>安裝套件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Ubuntu</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install parted</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> CentOS</span></span><br><span class="line">sudo yum install parted</span><br></pre></td></tr></table></figure><h3 id="進入-parted"><a href="#進入-parted" class="headerlink" title="進入 parted"></a>進入 <code>parted</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo parted</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/parted.PNG" class="" title="進入 parted"><h3 id="選擇硬碟"><a href="#選擇硬碟" class="headerlink" title="選擇硬碟"></a>選擇硬碟</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假設硬碟代號為 sdb</span></span><br><span class="line">select /dev/sdb</span><br><span class="line">print</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/select.PNG" class="" title="選擇硬碟"><h3 id="建立磁碟分割表"><a href="#建立磁碟分割表" class="headerlink" title="建立磁碟分割表"></a>建立磁碟分割表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mklabel gpt</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/mklabel.PNG" class="" title="建立磁碟分割表"><h3 id="建立磁碟分割區"><a href="#建立磁碟分割區" class="headerlink" title="建立磁碟分割區"></a>建立磁碟分割區</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkpart</span><br><span class="line">print</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/mkpart.PNG" class="" title="建立磁碟分割區"><h3 id="離開-parted"><a href="#離開-parted" class="headerlink" title="離開 parted"></a>離開 <code>parted</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quit</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/quit.PNG" class="" title="離開 parted"><h3 id="格式化磁碟分割區"><a href="#格式化磁碟分割區" class="headerlink" title="格式化磁碟分割區"></a>格式化磁碟分割區</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install xfsprogs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 假設硬碟代號為 sdb，要格式化第一個磁區 sdb1</span></span><br><span class="line">sudo mkfs.xfs -f /dev/sdb1</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/mkfs.PNG" class="" title="格式化磁碟分割區"><h3 id="掛載磁碟分割區"><a href="#掛載磁碟分割區" class="headerlink" title="掛載磁碟分割區"></a>掛載磁碟分割區</h3><h4 id="查詢磁碟分割區-UUID"><a href="#查詢磁碟分割區-UUID" class="headerlink" title="查詢磁碟分割區 UUID"></a>查詢磁碟分割區 <code>UUID</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo blkid -s UUID</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/UUID.PNG" class="" title="查詢磁碟分割區"><h4 id="創建要掛載的資料夾"><a href="#創建要掛載的資料夾" class="headerlink" title="創建要掛載的資料夾"></a>創建要掛載的資料夾</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假設資料夾為 data</span></span><br><span class="line">sudo mkdir /data</span><br></pre></td></tr></table></figure><h4 id="編輯-fstab"><a href="#編輯-fstab" class="headerlink" title="編輯 fstab"></a>編輯 <code>fstab</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/fstab</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># [Device] [Mount Point] [File System] [Options] [dump] [fsck order]</span><br><span class="line">UUID&#x3D;f6420c0d-b440-4d58-ba56-f4921d2221bb &#x2F;data xfs defaults 0 0</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/fstab.PNG" class="" title="編輯 fstab"><h4 id="重啟掛載表"><a href="#重啟掛載表" class="headerlink" title="重啟掛載表"></a>重啟掛載表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure><h4 id="驗證是否掛載成功"><a href="#驗證是否掛載成功" class="headerlink" title="驗證是否掛載成功"></a>驗證是否掛載成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/14/ubuntu-disk-partition/lsblk.PNG" class="" title="驗證是否掛載成功"><hr><h2 id="parted-其他常用指令"><a href="#parted-其他常用指令" class="headerlink" title="parted 其他常用指令"></a><code>parted</code> 其他常用指令</h2><h3 id="調整磁碟分割區大小"><a href="#調整磁碟分割區大小" class="headerlink" title="調整磁碟分割區大小"></a>調整磁碟分割區大小</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resizepart</span><br></pre></td></tr></table></figure><h3 id="刪除磁碟分割區"><a href="#刪除磁碟分割區" class="headerlink" title="刪除磁碟分割區"></a>刪除磁碟分割區</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假設硬碟代號為 sda，要刪除第一個磁區 sda1</span></span><br><span class="line">select /dev/sda1</span><br><span class="line">rm 1</span><br></pre></td></tr></table></figure><h3 id="修復磁碟分割區"><a href="#修復磁碟分割區" class="headerlink" title="修復磁碟分割區"></a>修復磁碟分割區</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 假設硬碟代號為 sda，要修復第一個磁區 sda1</span></span><br><span class="line">select /dev/sda1</span><br><span class="line">rescue</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DISK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Triton Inference Server 第一版介紹</title>
      <link href="2020/07/13/nvidia-triton-inference-server-v1/"/>
      <url>2020/07/13/nvidia-triton-inference-server-v1/</url>
      
        <content type="html"><![CDATA[<div class="note danger">            <p>2020/10/02 此版維護期限已到期，未來將不再更新，請轉至<a href="https://roychou121.github.io/2020/07/20/nvidia-triton-inference-server/">最新版</a>。</p>          </div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本章為提供給還在使用舊版的人參考，關於此套件的詳細說明也可都在最新版中查看。</p><hr><h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>GPU Driver：450.51.05</li><li>Docker：19.03.5</li><li>Docker Image：nvcr.io/nvidia/tritonserver:20.07-v1-py3</li></ul><h3 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h3><h4 id="安裝-Docker"><a href="#安裝-Docker" class="headerlink" title="安裝 Docker"></a>安裝 Docker</h4><p>本篇是將系統架設在 Docker 上，可以參考此<a href="https://roychou121.github.io/2020/07/13/ubuntu-install-docker/">文章</a> 將 Docker 環境建立起來。</p><h4 id="下載映像檔"><a href="#下載映像檔" class="headerlink" title="下載映像檔"></a>下載映像檔</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull nvcr.io/nvidia/tritonserver:20.07-v1-py3</span><br></pre></td></tr></table></figure><h3 id="運行步驟"><a href="#運行步驟" class="headerlink" title="運行步驟"></a>運行步驟</h3><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/server.png" class="" title="Server 流程圖"><h4 id="模型轉換"><a href="#模型轉換" class="headerlink" title="模型轉換"></a>模型轉換</h4><p>系統支援的模型如下，如訓練時所使用的框架非下述所示，則需進行轉換。</p><ul><li>Tensorflow (graphdef, savedmodel)</li><li>TensorRT (plan)</li><li>ONNX (onnx)</li><li>PyTorch (pt)</li><li>Caffe2 (netdef)</li></ul><div class="note info">            <p>為了增加系統效能，建議模型都要過 TensorRT 編譯。</p>          </div><h4 id="建立模型庫"><a href="#建立模型庫" class="headerlink" title="建立模型庫"></a>建立模型庫</h4><p>模型庫中保存著多個模型包。<br>每個模型包皆由版本及設定檔所組成，版本建議以自然數依序命名 (Ex. 1,2,3…)。</p><p>建立模型庫範例如下圖所示：<br>以此範例來說<br>模型庫為 <code>model-repository</code><br>模型庫中共存放了4個模型包 (<code>mnistTensorrt</code>, <code>mnist-tftrt</code>, <code>tensorflowGraphdef</code>, <code>tensorflowSavedmodel</code>)<br>其中以 <code>mnist-tftrt</code> 模型包為例，<code>mnist-tftrt</code> 為此模型的命名，資料夾中存放了版本 <code>1</code> 的模型及設定檔。</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/repository.png" class="" title="建立模型庫"><h4 id="編輯設定檔"><a href="#編輯設定檔" class="headerlink" title="編輯設定檔"></a>編輯設定檔</h4><p>每個模型包皆須有設定檔，系統會根據設定檔來運行模型，最基本的設定檔由 5 大元素組成：模型名稱、模型框架、最大批次大小、輸入及輸出層的資訊、GPU 實例資訊。</p><p>更詳盡的參數說明可以參考<a href="https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/model_configuration.html" target="_blank" rel="noopener">官方文件</a>。</p><p>編輯設定檔範例如下圖所示：</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/config.png" class="" title="編輯設定檔"><div class="note info">            <p>設定檔中的模型名稱需與資料夾的模型名稱一致。</p>          </div><div class="note info">            <p>最大批次大小為推論批次設定的最大值，不一定是實際推論批次大小。</p>          </div><h4 id="運行伺服器端"><a href="#運行伺服器端" class="headerlink" title="運行伺服器端"></a>運行伺服器端</h4><p>在運行前需指定此服務要跑幾個 GPU、走哪些 Port 以及模型庫的路徑。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --gpus &lt;GPU Number&gt; --name &lt;Conatainer Name&gt; --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p &lt;Host Port&gt;:8000 -p &lt;Host Port&gt;:8001 -p &lt;Host Port&gt;:8002 -v &lt;Model Repository Path&gt;:/models nvcr.io/nvidia/tritonserver:20.07-v1-py3 tritonserver --model-store=/models</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example</span></span><br><span class="line">sudo docker run -d --gpus all --name Triton_Server --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p 8000:8000 -p 8001:8001 -p 8002:8002 -v /home/user/Documents/model-repository:/models nvcr.io/nvidia/tritonserver:20.07-v1-py3 tritonserver --model-store=/models</span><br></pre></td></tr></table></figure><div class="note info">            <p>Port 8000 為 HTTP 協定通道<br>Port 8001 為 GRPC 協定通道</p>          </div><h4 id="檢查系統狀態"><a href="#檢查系統狀態" class="headerlink" title="檢查系統狀態"></a>檢查系統狀態</h4><p>檢查系統是否正常的運行中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v localhost:8000/api/status</span><br></pre></td></tr></table></figure><p>Triton 提供 Prometheus Metrics，內容主要為 GPU 狀態和請求統計資訊等：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v http://localhost:8002/metrics</span><br></pre></td></tr></table></figure><hr><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><h3 id="系統環境-1"><a href="#系統環境-1" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>Docker：19.03.5</li><li>Docker Image：nvcr.io/nvidia/tritonserver:20.07-v1-py3-clientsdk</li></ul><h3 id="安裝步驟-1"><a href="#安裝步驟-1" class="headerlink" title="安裝步驟"></a>安裝步驟</h3><h4 id="安裝-Docker-1"><a href="#安裝-Docker-1" class="headerlink" title="安裝 Docker"></a>安裝 Docker</h4><p>本篇是將系統架設在 Docker 上，可以參考此<a href="https://roychou121.github.io/2020/07/13/ubuntu-install-docker/">文章</a> 將 Docker 環境建立起來。</p><h4 id="下載映像檔-1"><a href="#下載映像檔-1" class="headerlink" title="下載映像檔"></a>下載映像檔</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull nvcr.io/nvidia/tritonserver:20.07-v1-py3-clientsdk</span><br></pre></td></tr></table></figure><h3 id="運行步驟-1"><a href="#運行步驟-1" class="headerlink" title="運行步驟"></a>運行步驟</h3><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/client.png" class="" title="Client 流程圖"><h4 id="串接設備"><a href="#串接設備" class="headerlink" title="串接設備"></a>串接設備</h4><p>目前主流要推論的資料為數據、影像、聲音以及文字，在跟 Server 端溝通之前，Client 端需先跟各設備進行串接。</p><p>如影像型推論，就需跟攝影機、機台、儲存設備、呈現平台…等串接。</p><h4 id="撰寫程式碼"><a href="#撰寫程式碼" class="headerlink" title="撰寫程式碼"></a>撰寫程式碼</h4><p>Client 端程式碼撰寫主要分成三大部分，依序為</p><ul><li>前處理<br>此部分主要處裡的事項為資訊進模型前的所有處理，如影像解碼、維度轉換、訊號處理等等。</li><li>Client-Server 溝通<br>指定將推論的模型資訊，透過 HTTP 或 GRPC 跟 Server 溝通。<br>詳細的函數說明可以參考<a href="https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/client_example.html" target="_blank" rel="noopener">官方文件</a>或<a href="https://github.com/NVIDIA/triton-inference-server/tree/master/src/clients/python/examples" target="_blank" rel="noopener">官方範例</a>。</li><li>後處理<br>此部分主要處裡的事項為接到 Server 回傳來推論結果後的所有處理，如儲存檔案、訊息整理、結果呈現等等。</li></ul><div class="note info">            <p>前後處理會因不同的應用實例有所差異，此部分不是本章的重點。<br>本章將會著重在說明 Triton Client-Server 基本的溝通函數，其他更深入的函數將在日後介紹。</p>          </div><h4 id="運行客戶端"><a href="#運行客戶端" class="headerlink" title="運行客戶端"></a>運行客戶端</h4><p>在運行前需確認 Server 的 IP、走的協定 (HTTP or GRPC) 以及讀取儲存資料的位置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --name &lt;Container Name&gt; -v &lt;Data Path&gt;:/data nvcr.io/nvidia/tritonserver:20.07-v1-py3-clientsdk bash -c '&lt;Client Code&gt;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Example</span></span><br><span class="line">sudo docker run -d --name Triton_Client -v /home/user/Documents/data:/data nvcr.io/nvidia/tritonserver:20.07-v1-py3-clientsdk bash -c 'python /data/client.py'</span><br></pre></td></tr></table></figure><hr><h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>接下來將以大家耳熟能詳的 <a href="https://www.tensorflow.org/quantum/tutorials/mnist" target="_blank" rel="noopener">MNIST</a> 所訓練出的模型當作範例，由於訓練模型不是本篇的重點，可以直接下載訓練好的模型進行後續的練習。</p><h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><h4 id="訓練模型"><a href="#訓練模型" class="headerlink" title="訓練模型"></a>訓練模型</h4><p>此部分以 MNIST 資料集和簡單的 CNN 模型當作範例。<br>撰寫框架為 Kears，來源為<a href="https://www.tensorflow.org/datasets/keras_example" target="_blank" rel="noopener">官方範本</a>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow.compat.v2 <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_datasets <span class="keyword">as</span> tfds</span><br><span class="line"></span><br><span class="line">tfds.disable_progress_bar()</span><br><span class="line">tf.enable_v2_behavior()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(ds_train, ds_test), ds_info = tfds.load(</span><br><span class="line">    <span class="string">'mnist'</span>,</span><br><span class="line">    split=[<span class="string">'train'</span>, <span class="string">'test'</span>],</span><br><span class="line">    shuffle_files=<span class="literal">True</span>,</span><br><span class="line">    as_supervised=<span class="literal">True</span>,</span><br><span class="line">    with_info=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_img</span><span class="params">(image, label)</span>:</span></span><br><span class="line">  <span class="string">"""Normalizes images: `uint8` -&gt; `float32`."""</span></span><br><span class="line">  <span class="keyword">return</span> tf.cast(image, tf.float32) / <span class="number">255.</span>, label</span><br><span class="line"></span><br><span class="line">ds_train = ds_train.map(</span><br><span class="line">    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">ds_train = ds_train.cache()</span><br><span class="line">ds_train = ds_train.shuffle(ds_info.splits[<span class="string">'train'</span>].num_examples)</span><br><span class="line">ds_train = ds_train.batch(<span class="number">128</span>)</span><br><span class="line">ds_train = ds_train.prefetch(tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ds_test = ds_test.map(</span><br><span class="line">    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)</span><br><span class="line">ds_test = ds_test.batch(<span class="number">128</span>)</span><br><span class="line">ds_test = ds_test.cache()</span><br><span class="line">ds_test = ds_test.prefetch(tf.data.experimental.AUTOTUNE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model = tf.keras.models.Sequential([</span><br><span class="line">  tf.keras.layers.Flatten(input_shape=(<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>)),</span><br><span class="line">  tf.keras.layers.Dense(<span class="number">128</span>,activation=<span class="string">'relu'</span>),</span><br><span class="line">  tf.keras.layers.Dense(<span class="number">10</span>, activation=<span class="string">'softmax'</span>)</span><br><span class="line">])</span><br><span class="line">model.compile(</span><br><span class="line">    loss=<span class="string">'sparse_categorical_crossentropy'</span>,</span><br><span class="line">    optimizer=tf.keras.optimizers.Adam(<span class="number">0.001</span>),</span><br><span class="line">    metrics=[<span class="string">'accuracy'</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model.fit(</span><br><span class="line">    ds_train,</span><br><span class="line">    epochs=<span class="number">6</span>,</span><br><span class="line">    validation_data=ds_test,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 模型儲存</span></span><br><span class="line">model.save(<span class="string">'mnist'</span>)</span><br></pre></td></tr></table></figure><h4 id="模型轉換-1"><a href="#模型轉換-1" class="headerlink" title="模型轉換"></a>模型轉換</h4><p>由於儲存的模型已是 SavedModel 格式，所以此步只需用 TensorRT 編譯優化即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.python.compiler.tensorrt <span class="keyword">import</span> trt_convert <span class="keyword">as</span> trt</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">conversion_params = trt.DEFAULT_TRT_CONVERSION_PARAMS</span><br><span class="line">conversion_params = conversion_params._replace(max_workspace_size_bytes=(<span class="number">1</span>&lt;&lt;<span class="number">32</span>))</span><br><span class="line">conversion_params = conversion_params._replace(precision_mode=<span class="string">"FP16"</span>)</span><br><span class="line">conversion_params = conversion_params._replace(maximum_cached_engines=<span class="number">128</span>)</span><br><span class="line">conversion_params = conversion_params._replace(use_calibration=<span class="literal">False</span>)</span><br><span class="line">conversion_params = conversion_params._replace(max_batch_size=<span class="number">32</span>)</span><br><span class="line">converter = trt.TrtGraphConverterV2(input_saved_model_dir=<span class="string">'mnist'</span>, conversion_params=conversion_params)</span><br><span class="line">converter.convert()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_fn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">yield</span> [tf.random.normal((<span class="number">32</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>))]</span><br><span class="line">converter.build(input_fn)</span><br><span class="line">converter.save(<span class="string">'model.savedmodel'</span>)</span><br></pre></td></tr></table></figure><h4 id="建立模型庫-1"><a href="#建立模型庫-1" class="headerlink" title="建立模型庫"></a>建立模型庫</h4><p>以上面的模型為例，建立出的模型庫如下圖所示。</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/repository_ex.PNG" class="" title="建立模型庫"><h4 id="編輯設定檔-1"><a href="#編輯設定檔-1" class="headerlink" title="編輯設定檔"></a>編輯設定檔</h4><p>以下的參數為必要欄位，其他深入或客製化的參數，可以參考<a href="https://docs.nvidia.com/deeplearning/triton-inference-server/master-user-guide/docs/model_configuration.html" target="_blank" rel="noopener">官網文件</a>。</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="string">"mnist"</span></span><br><span class="line">platform: <span class="string">"tensorflow_savedmodel"</span></span><br><span class="line">max_batch_size: <span class="number">32</span></span><br><span class="line">input [</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">"flatten_input"</span></span><br><span class="line">        data_type: TYPE_FP32</span><br><span class="line">        format: FORMAT_NHWC</span><br><span class="line">        dims: [<span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">output [</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">"dense_1"</span></span><br><span class="line">        data_type: TYPE_FP32</span><br><span class="line">        dims: [<span class="number">10</span>]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">instance_group [</span><br><span class="line">    &#123;</span><br><span class="line">        kind: KIND_GPU</span><br><span class="line">        count: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="運行伺服器端-1"><a href="#運行伺服器端-1" class="headerlink" title="運行伺服器端"></a>運行伺服器端</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --gpus all --name Triton_Server --shm-size=1g --ulimit memlock=-1 --ulimit stack=67108864 -p 8000:8000 -p 8001:8001 -p 8002:8002 -v /home/user/Documents/model-repository:/models nvcr.io/nvidia/tritonserver:20.06-py3 tritonserver --model-store=/models</span><br></pre></td></tr></table></figure><p>運行伺服器端後，成功的畫面如下所示。</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/runServer.PNG" class="" title="運行伺服器端成功畫面"><h3 id="Cleint"><a href="#Cleint" class="headerlink" title="Cleint"></a>Cleint</h3><h4 id="串接設備-1"><a href="#串接設備-1" class="headerlink" title="串接設備"></a>串接設備</h4><p>由於沒有實際的設備可以串接，此部分直接取用 MNIST 測試資料集中一張影像當作範例，最後將接到的推論結果直接顯示在螢幕上。</p><p>MNIST 測試資料如下圖所示。</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/input.jpg" class="" title="測試資料"><h4 id="撰寫程式碼-1"><a href="#撰寫程式碼-1" class="headerlink" title="撰寫程式碼"></a>撰寫程式碼</h4><figure class="highlight python"><figcaption><span>client.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tritongrpcclient</span><br><span class="line"><span class="keyword">from</span> tritonclientutils <span class="keyword">import</span> triton_to_np_dtype</span><br><span class="line"></span><br><span class="line"><span class="comment">## 前處理</span></span><br><span class="line">img = Image.open(<span class="string">'test.jpg'</span>).convert(<span class="string">'L'</span>)</span><br><span class="line">img = img.resize((<span class="number">28</span>, <span class="number">28</span>))</span><br><span class="line">imgArr = np.asarray(img)/<span class="number">255</span></span><br><span class="line">imgArr = np.expand_dims(imgArr[:, :, np.newaxis], <span class="number">0</span>)</span><br><span class="line">imgArr= imgArr.astype(triton_to_np_dtype(<span class="string">'FP32'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">## Client-Server 溝通</span></span><br><span class="line">protocol = ProtocolType.from_str(<span class="string">"gRPC"</span>)</span><br><span class="line">ctx = InferContext(url=<span class="string">'localhost:8001'</span>, protocol, <span class="string">'mnist'</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">responses = []</span><br><span class="line">responses.append(ctx.run(</span><br><span class="line">    &#123;<span class="string">"flatten_input"</span>:[imgArr]&#125;,</span><br><span class="line">    &#123;<span class="string">"dense_1"</span>:InferContext.ResultFormat.RAW&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 後處理</span></span><br><span class="line"><span class="keyword">print</span> (np.argmax(responses[<span class="number">0</span>].as_numpy(<span class="string">'dense_1'</span>)[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure><h4 id="運行客戶端-1"><a href="#運行客戶端-1" class="headerlink" title="運行客戶端"></a>運行客戶端</h4><p>將客戶端環境運行起來後，執行上部撰寫好的程式碼，即可進行推論。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --rm --name Triton_Client -v /home/user/data:/data nvcr.io/nvidia/tritonserver:20.07-v1-py3-clientsdk bash -c 'python /data/client.py'</span><br></pre></td></tr></table></figure><p>最後 MNIST 推論結果如下圖所示，可以發現有成功的預測出數字。</p><img src= "/img/loading.gif" data-src="/2020/07/13/nvidia-triton-inference-server-v1/result.PNG" class="" title="結果"><hr><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol><li><p><a href="https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/index.html" target="_blank" rel="noopener">Triton Inference Server Docs</a></p></li><li><p><a href="https://github.com/NVIDIA/triton-inference-server" target="_blank" rel="noopener">Triton Inference Server Github</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> Inference </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
            <tag> INFERENCE </tag>
            
            <tag> SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 安裝 Docker (支援 GPU)</title>
      <link href="2020/07/13/ubuntu-install-docker/"/>
      <url>2020/07/13/ubuntu-install-docker/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Docker 是一個開源專案，誕生於 2013 年初，最初是 dotCloud 公司內部的一個業餘專案。它基於 Google 公司推出的 Go 語言實作。 專案後來加入了 Linux 基金會，遵從了 Apache 2.0 協議，原始碼在 GitHub 上進行維護。</p><p>Docker 自開源後受到廣泛的關注和討論，以至於 dotCloud 公司後來都改名為 Docker Inc。Redhat 已經在其 RHEL6.5 中集中支援 Docker；Google 也在其 PaaS 產品中廣泛應用。</p><p>Docker 專案的目標是實作輕量級的作業系統虛擬化解決方案。 Docker 的基礎是 Linux 容器（LXC）等技術。</p><p>在 LXC 的基礎上 Docker 進行了進一步的封裝，讓使用者不需要去關心容器的管理，使得操作更為簡便。使用者操作 Docker 的容器就像操作一個快速輕量級的虛擬機一樣簡單。</p><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/dockerCmd.png" class="" title="Docker 常用指令"><hr><h2 id="Docker-基本概念"><a href="#Docker-基本概念" class="headerlink" title="Docker 基本概念"></a>Docker 基本概念</h2><h3 id="映像檔-Image"><a href="#映像檔-Image" class="headerlink" title="映像檔 (Image)"></a>映像檔 (Image)</h3><ul><li>Docker 映像檔就是一個唯讀的模板。</li><li>映像檔可以用來建立 Docker 容器。</li><li>Docker 提供了一個很簡單的機制來建立映像檔或者更新現有的映像檔，使用者甚至可以直接從Docker Hub下載一個已經做好的映像檔來直接使用。</li></ul><h3 id="容器-Container"><a href="#容器-Container" class="headerlink" title="容器 (Container)"></a>容器 (Container)</h3><ul><li>容器是從映像檔建立的執行實例。它可以被啟動、開始、停止、刪除。每個容器都是相互隔離的、保證安全的平台。</li><li>可以把容器看做是一個簡易版的 Linux 環境（包括root使用者權限、程式空間、使用者空間和網路空間等）和在其中執行的應用程式。</li></ul><h3 id="倉庫-Repository"><a href="#倉庫-Repository" class="headerlink" title="倉庫 (Repository)"></a>倉庫 (Repository)</h3><ul><li>倉庫分為公開倉庫（Public）和私有倉庫（Private）兩種形式。</li><li>最大的公開倉庫是 <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a>，存放了數量龐大的映像檔供使用者下載。</li><li>NVIDIA AI 倉庫為 <a href="https://ngc.nvidia.com" target="_blank" rel="noopener">NGC</a>，存放了 AI 常用框架的映像檔供使用者下載。</li></ul><hr><h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04</li><li>Docker：19.03</li><li>NVIDIA Container Toolkit：1.2.0</li></ul><h3 id="步驟"><a href="#步驟" class="headerlink" title="步驟"></a>步驟</h3><h4 id="安裝相依性套件"><a href="#安裝相依性套件" class="headerlink" title="安裝相依性套件"></a>安裝相依性套件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</span><br></pre></td></tr></table></figure><h4 id="添加-Docker-GPG-key"><a href="#添加-Docker-GPG-key" class="headerlink" title="添加 Docker GPG key"></a>添加 Docker GPG key</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo apt-key fingerprint 0EBFCD88</span><br></pre></td></tr></table></figure><h4 id="添加-Docker-套件庫-穩定版"><a href="#添加-Docker-套件庫-穩定版" class="headerlink" title="添加 Docker 套件庫 (穩定版)"></a>添加 Docker 套件庫 (穩定版)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"</span><br></pre></td></tr></table></figure><h4 id="安裝-docker-ce-docker-ce-cli-containerd-io"><a href="#安裝-docker-ce-docker-ce-cli-containerd-io" class="headerlink" title="安裝 docker-ce docker-ce-cli containerd.io"></a>安裝 <code>docker-ce</code> <code>docker-ce-cli</code> <code>containerd.io</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><h4 id="添加-NVIDIA-Docker-套件庫"><a href="#添加-NVIDIA-Docker-套件庫" class="headerlink" title="添加 NVIDIA Docker 套件庫"></a>添加 NVIDIA Docker 套件庫</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br></pre></td></tr></table></figure><h4 id="安裝-NVIDIA-Container-Toolkit"><a href="#安裝-NVIDIA-Container-Toolkit" class="headerlink" title="安裝 NVIDIA Container Toolkit"></a>安裝 NVIDIA Container Toolkit</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nvidia-container-toolkit</span><br></pre></td></tr></table></figure><h4 id="重啟-Docker"><a href="#重啟-Docker" class="headerlink" title="重啟 Docker"></a>重啟 Docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h4 id="執行-Docker-不加-Sudo-選"><a href="#執行-Docker-不加-Sudo-選" class="headerlink" title="執行 Docker 不加 Sudo (選)"></a>執行 Docker 不加 Sudo (選)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br><span class="line">sudo service docker restart</span><br></pre></td></tr></table></figure><hr><h2 id="Docker-基本操作"><a href="#Docker-基本操作" class="headerlink" title="Docker 基本操作"></a>Docker 基本操作</h2><h3 id="搜尋映像檔-search"><a href="#搜尋映像檔-search" class="headerlink" title="搜尋映像檔 search"></a>搜尋映像檔 <code>search</code></h3><p>在 Docker Hub 上尋找，會顯示熱度前幾名的映像檔。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker search &lt;Image Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/search.PNG" class="" title="Docker search 範例"><h3 id="取得映像檔-pull"><a href="#取得映像檔-pull" class="headerlink" title="取得映像檔 pull"></a>取得映像檔 <code>pull</code></h3><p>將映像檔從倉庫下載到本機。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull &lt;Image Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/pull.PNG" class="" title="Docker pull 範例"><h3 id="全部映像檔-images"><a href="#全部映像檔-images" class="headerlink" title="全部映像檔 images"></a>全部映像檔 <code>images</code></h3><p>顯示本機已下載的映像檔。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker images</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/images.PNG" class="" title="Docker images 範例"><h3 id="建立容器-run"><a href="#建立容器-run" class="headerlink" title="建立容器 run"></a>建立容器 <code>run</code></h3><p>建立容器並啟用。</p><table><thead><tr><th>Tag</th><th>Description</th></tr></thead><tbody><tr><td>-it</td><td>配置一個虛擬的終端機以及讓標準輸入維持在打開的狀態</td></tr><tr><td>-d</td><td>背景執行</td></tr><tr><td>–rm</td><td>Container 執行結束後自動刪除</td></tr><tr><td>–name <name></td><td>為 Container 命名</td></tr><tr><td>-p <host>:<container></td><td>將主機的 Port 綁定到 Container 的Port</td></tr><tr><td>-v <host>:<container></td><td>將主機的資料夾掛載到 Container 資料夾</td></tr><tr><td>–gpus ‘“device=<GPU ID>“‘</td><td>指定使用 GPU 編號</td></tr><tr><td>–gpus 2</td><td>指定使用前幾個 GPU</td></tr><tr><td>–gpus all</td><td>使用全部的 GPU</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -it --name test --gpus all -p 20000:8888 -v /raid:/data nvcr.io/nvidia/tensorflow:20.06-tf2-py3 bash</span><br></pre></td></tr></table></figure><div class="note warning">            <p>可透過 <code>exit</code> 中回到本機系統，但第一次離開會停止容器的運行。</p>          </div><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/run.PNG" class="" title="Docker run 範例"><h3 id="全部容器-ps-a"><a href="#全部容器-ps-a" class="headerlink" title="全部容器 ps -a"></a>全部容器 <code>ps -a</code></h3><p>顯示本機已建立的容器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps -a</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/ps.PNG" class="" title="顯示本機已建立的容器"><h3 id="進入運行中的容器"><a href="#進入運行中的容器" class="headerlink" title="進入運行中的容器"></a>進入運行中的容器</h3><h4 id="使用-exec"><a href="#使用-exec" class="headerlink" title="使用 exec"></a>使用 <code>exec</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker exec -it &lt;Container ID or Name&gt; bash</span><br></pre></td></tr></table></figure><div class="note info">            <p>執行 exit 時，不會中止容器。</p>          </div><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/exec.PNG" class="" title="進入運行中的容器"><h4 id="使用-attach"><a href="#使用-attach" class="headerlink" title="使用 attach"></a>使用 <code>attach</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker attach &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><div class="note info">            <p>執行 exit 時，就會中止容器。</p>          </div><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/attach.PNG" class="" title="進入運行中的容器"><h3 id="啟用容器-start"><a href="#啟用容器-start" class="headerlink" title="啟用容器 start"></a>啟用容器 <code>start</code></h3><p>啟動停止的容器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker start &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/start.PNG" class="" title="啟動停止的容器"><h3 id="停止容器-stop"><a href="#停止容器-stop" class="headerlink" title="停止容器 stop"></a>停止容器 <code>stop</code></h3><p>停止啟用的容器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/stop.PNG" class="" title="停止啟用的容器"><h3 id="打包容器-commit"><a href="#打包容器-commit" class="headerlink" title="打包容器 commit"></a>打包容器 <code>commit</code></h3><p>將容器包成映像檔。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit &lt;Container ID or Name&gt; &lt;Image Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/commit.PNG" class="" title="將容器包成映像檔"><h3 id="打包映像檔-save"><a href="#打包映像檔-save" class="headerlink" title="打包映像檔 save"></a>打包映像檔 <code>save</code></h3><p>將映像檔打包成檔案。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker save -o &lt;File Name&gt;.tar &lt;Image Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/save.PNG" class="" title="將映像檔打包成檔案"><h3 id="載入映像檔-load"><a href="#載入映像檔-load" class="headerlink" title="載入映像檔 load"></a>載入映像檔 <code>load</code></h3><p>將打包的映像檔檔案載入本機。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker load -i &lt;File Name&gt;.tar</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/load.PNG" class="" title="將打包的映像檔檔案載入本機"><h3 id="刪除容器-rm"><a href="#刪除容器-rm" class="headerlink" title="刪除容器 rm"></a>刪除容器 <code>rm</code></h3><p>刪除容器，如容器還在運行，可加 <code>-f</code> ，強制刪除。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm &lt;Container ID or Name&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 強制刪除</span></span><br><span class="line">sudo docker rm -f &lt;Container ID or Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/rm.PNG" class="" title="刪除容器"><h3 id="刪除映像檔-rmi"><a href="#刪除映像檔-rmi" class="headerlink" title="刪除映像檔 rmi"></a>刪除映像檔 <code>rmi</code></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rmi &lt;Image Name&gt;</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/13/ubuntu-install-docker/rmi.PNG" class="" title="刪除映像檔"><hr><h2 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h2><h3 id="安裝-nvidia-docker2"><a href="#安裝-nvidia-docker2" class="headerlink" title="安裝 nvidia-docker2"></a>安裝 <code>nvidia-docker2</code></h3><div class="note danger">            <p>Docker 版本小於 <code>19.03</code>，又要使用 GPU 了話，要改安裝 <code>nvidia-docker2</code>，不過此套件過一陣子將不再支援，不建議安裝。</p>          </div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 此範例 Docker 版本為 18.06</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce=18.06.1~ce~3-0~ubuntu</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="line">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y nvidia-docker2=2.0.3+docker18.06.1-1 nvidia-container-runtime=2.0.0+docker18.06.1-1</span><br><span class="line">sudo pkill -SIGHUP dockerd</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DOCKER </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 安裝 Tensorflow 2.2</title>
      <link href="2020/07/12/ubuntu-install-tensorflow/"/>
      <url>2020/07/12/ubuntu-install-tensorflow/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前主流 AI 開發框架為 <a href="https://www.tensorflow.org/?hl=zh-tw" target="_blank" rel="noopener">Tensorflow</a> 及 <a href="https://pytorch.org/" target="_blank" rel="noopener">Pytorch</a>，本章將教學如何在系統上安裝 Tensorflow。</p><div class="note info">            <p>如要運行在 GPU 上，系統需先安裝好 GPU 驅動，未安裝可參考<a href="https://roychou121.github.io/2020/07/12/ubuntu-install-gpu-driver/">此篇</a>。</p>          </div><div class="note info">            <p>推薦使用 Docker 的環境進行 Tensorflow 的開發，可參考<a href="https://roychou121.github.io/2020/07/13/ubuntu-install-docker/">此篇</a>。</p>          </div><hr><h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04 Desktop</li><li>GPU Driver：450.51.05</li><li>CUDA：10.2.89</li><li>cuDNN：8.0.0.180</li><li>Tensorflow：2.2</li></ul><h3 id="步驟"><a href="#步驟" class="headerlink" title="步驟"></a>步驟</h3><h4 id="安裝相依性套件"><a href="#安裝相依性套件" class="headerlink" title="安裝相依性套件"></a>安裝相依性套件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install wget gnupg2</span><br></pre></td></tr></table></figure><h4 id="添加-NVIDIA-套件庫"><a href="#添加-NVIDIA-套件庫" class="headerlink" title="添加 NVIDIA 套件庫"></a>添加 NVIDIA 套件庫</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-repo-ubuntu1804_10.2.89-1_amd64.deb</span><br><span class="line">sudo apt-key adv --fetch-keys http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/7fa2af80.pub</span><br><span class="line">sudo dpkg -i cuda-repo-ubuntu1804_10.2.89-1_amd64.deb</span><br><span class="line">sudo apt-get update</span><br><span class="line">wget http://developer.download.nvidia.com/compute/machine-learning/repos/ubuntu1804/x86_64/nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.deb</span><br><span class="line">sudo apt install ./nvidia-machine-learning-repo-ubuntu1804_1.0.0-1_amd64.deb</span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure><h4 id="安裝-CUDA-cuDNN"><a href="#安裝-CUDA-cuDNN" class="headerlink" title="安裝 CUDA cuDNN"></a>安裝 CUDA cuDNN</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cuda-10-2 libcudnn8=8.0.0.180-1+cuda10.2 libcudnn8-dev=8.0.0.180-1+cuda10.2</span><br></pre></td></tr></table></figure><div class="note warning">            <p>此方法安裝 CUDA，將會自帶安裝 GPU 驅動。為避免蓋掉舊有的驅動，可從<a href="https://developer.nvidia.com/cuda-toolkit" target="_blank" rel="noopener">官網</a>下載 <code>run</code> 檔手動安裝(記得將安裝驅動的選項關掉)。</p>          </div><h4 id="手動安裝-CUDA-cuDNN-選"><a href="#手動安裝-CUDA-cuDNN-選" class="headerlink" title="手動安裝 CUDA cuDNN (選)"></a>手動安裝 CUDA cuDNN (選)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://developer.download.nvidia.com/compute/cuda/10.2/Prod/local_installers/cuda_10.2.89_440.33.01_linux.run</span><br><span class="line">sudo sh cuda_10.2.89_440.33.01_linux.run</span><br><span class="line">sudo apt-get install libcudnn8=8.0.0.180-1+cuda10.2 libcudnn8-dev=8.0.0.180-1+cuda10.2</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-tensorflow/cudarun.PNG" class="" title="記得關掉安裝 GPU 驅動"><h4 id="將-CUDA-加進環境變數-bashrc"><a href="#將-CUDA-加進環境變數-bashrc" class="headerlink" title="將 CUDA 加進環境變數 ~/.bashrc"></a>將 CUDA 加進環境變數 <code>~/.bashrc</code></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.bashrc</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;cuda&#x2F;bin:$PATH</span><br><span class="line">export LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;cuda&#x2F;lib64:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure><h4 id="激活環境變數"><a href="#激活環境變數" class="headerlink" title="激活環境變數"></a>激活環境變數</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h4 id="檢查-CUDA-是否安裝成功"><a href="#檢查-CUDA-是否安裝成功" class="headerlink" title="檢查 CUDA 是否安裝成功"></a>檢查 CUDA 是否安裝成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-tensorflow/cuda.PNG" class="" title="確認 CUDA 是否安裝成功"><h4 id="安裝-Tensorflow"><a href="#安裝-Tensorflow" class="headerlink" title="安裝 Tensorflow"></a>安裝 Tensorflow</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install python3-dev python3-pip</span><br><span class="line">pip3 install  tensorflow==2.2.0</span><br></pre></td></tr></table></figure><h4 id="檢查-Tensorflow-是否安裝成功"><a href="#檢查-Tensorflow-是否安裝成功" class="headerlink" title="檢查 Tensorflow 是否安裝成功"></a>檢查 Tensorflow 是否安裝成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c "import tensorflow as tf; print(tf.__version__); print(tf.reduce_sum(tf.random.normal([1000, 1000])))"</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-tensorflow/tensorflow.PNG" class="" title="確認版本及可正常使用">]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> Install </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI </tag>
            
            <tag> TENSORFLOW </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 18.04 安裝 NVIDIA 顯示卡驅動</title>
      <link href="2020/07/12/ubuntu-install-gpu-driver/"/>
      <url>2020/07/12/ubuntu-install-gpu-driver/</url>
      
        <content type="html"><![CDATA[<div class="note info">            <p>2021/01/22 驅動版本更新至 v460.32.03</p>          </div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>安裝驅動的方法很多種，可透過 <code>deb</code> 或是 <code>run</code> 檔等進行安裝，步驟大同小異。<br>其中如果作業系統為桌面版，在安裝 GPU 驅動時，會與預設顯示驅動衝突，造成顯示異常等狀況，所以本次教學將分成桌面及伺服器版兩個部分。</p><div class="note warning">            <p>如要安裝 CUDA ，要注意透過 <code>deb</code> 或是 <code>apt</code> 安裝，將會自帶安裝 GPU 驅動。為避免蓋掉舊有的驅動，可從<a href="https://developer.nvidia.com/cuda-toolkit" target="_blank" rel="noopener">官網</a>下載 <code>run</code> 檔手動安裝(記得將安裝驅動的選項關掉)。</p>          </div><hr><h2 id="桌面版"><a href="#桌面版" class="headerlink" title="桌面版"></a>桌面版</h2><h3 id="系統環境"><a href="#系統環境" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04 Desktop</li><li>GPU Driver：460.32.03</li></ul><h3 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h3><h4 id="下載驅動"><a href="#下載驅動" class="headerlink" title="下載驅動"></a>下載驅動</h4><p>請至<a href="https://www.nvidia.com.tw/Download/index.aspx?lang=tw" target="_blank" rel="noopener">NVIDIA 驅動程式下載</a>網站選擇型號、作業系統、CUDA版本、語言後即可下載。</p><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-gpu-driver/download.PNG" class="" title="下載驅動頁面範例"><p>或是透過指令下載</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install wget</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 418.152.00 (CUDA 10.1)</span></span><br><span class="line">wget http://us.download.nvidia.com/tesla/418.152.00/NVIDIA-Linux-x86_64-418.152.00.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 440.95.01 (CUDA 10.2)</span></span><br><span class="line">wget http://us.download.nvidia.com/tesla/440.95.01/NVIDIA-Linux-x86_64-440.95.01.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 450.102.04 (CUDA 11.0)</span></span><br><span class="line">wget https://us.download.nvidia.com/tesla/450.102.04/NVIDIA-Linux-x86_64-450.102.04.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 460.32.03 (CUDA 11.2)</span></span><br><span class="line">wget https://us.download.nvidia.com/tesla/460.32.03/NVIDIA-Linux-x86_64-460.32.03.run</span><br></pre></td></tr></table></figure><h4 id="移除舊有-GPU-驅動"><a href="#移除舊有-GPU-驅動" class="headerlink" title="移除舊有 GPU 驅動"></a>移除舊有 GPU 驅動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get purge nvidia*</span><br></pre></td></tr></table></figure><h4 id="查看-nouveau-是否正在執行"><a href="#查看-nouveau-是否正在執行" class="headerlink" title="查看 nouveau 是否正在執行"></a>查看 nouveau 是否正在執行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep nouveau</span><br></pre></td></tr></table></figure><p>如果有就要編輯 <code>/etc/modprobe.d/blacklist-nouveau.conf</code> 文件來禁止</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/modprobe.d/blacklist-nouveau.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blacklist nouveau</span><br><span class="line">options nouveau modeset&#x3D;0</span><br></pre></td></tr></table></figure><p>更新後重啟電腦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h4 id="再次查看-nouveau-是否正在執行"><a href="#再次查看-nouveau-是否正在執行" class="headerlink" title="再次查看 nouveau 是否正在執行"></a>再次查看 nouveau 是否正在執行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep nouveau</span><br></pre></td></tr></table></figure><p>如果有就編輯 <code>/etc/modprobe.d/blacklist.conf</code> ，如果沒有就跳到下一步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/modprobe.d/blacklist.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">blacklist vga16fb</span><br><span class="line">blacklist nouveau</span><br><span class="line">blacklist rivafb</span><br><span class="line">blacklist rivatv</span><br><span class="line">blacklist nvidiafb</span><br></pre></td></tr></table></figure><p>再次更新後重啟電腦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h4 id="安裝相依的軟體"><a href="#安裝相依的軟體" class="headerlink" title="安裝相依的軟體"></a>安裝相依的軟體</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install gcc make cmake dkms build-essential lib32ncurses5 lib32z1 lightdm</span><br></pre></td></tr></table></figure><h4 id="停用圖形化界面"><a href="#停用圖形化界面" class="headerlink" title="停用圖形化界面"></a>停用圖形化界面</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 方法1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 透過 Ctrl+Alt+F1 進入終端機界面</span></span><br><span class="line">sudo service lightdm stop</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法2</span></span><br><span class="line">sudo init 3</span><br></pre></td></tr></table></figure><h4 id="安裝驅動"><a href="#安裝驅動" class="headerlink" title="安裝驅動"></a>安裝驅動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash NVIDIA-Linux-x86_64-460.32.03.run -no-opengl-files  -no-x-check -no-nouveau-check</span><br></pre></td></tr></table></figure><h4 id="啟動圖形化界面並重新啟動"><a href="#啟動圖形化界面並重新啟動" class="headerlink" title="啟動圖形化界面並重新啟動"></a>啟動圖形化界面並重新啟動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service lightdm start</span><br><span class="line">sudo update-initramfs -u</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h4 id="驗證安裝"><a href="#驗證安裝" class="headerlink" title="驗證安裝"></a>驗證安裝</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-gpu-driver/nvidiasmi.PNG" class="" title="GPU 相關資訊"><hr><h2 id="伺服器版"><a href="#伺服器版" class="headerlink" title="伺服器版"></a>伺服器版</h2><h3 id="系統環境-1"><a href="#系統環境-1" class="headerlink" title="系統環境"></a>系統環境</h3><ul><li>OS：Ubuntu 18.04 Server</li><li>GPU Driver：460.32.03</li></ul><h3 id="安裝方法一-run"><a href="#安裝方法一-run" class="headerlink" title="安裝方法一 run"></a>安裝方法一 <code>run</code></h3><h4 id="下載驅動-1"><a href="#下載驅動-1" class="headerlink" title="下載驅動"></a>下載驅動</h4><p>請至<a href="https://www.nvidia.com.tw/Download/index.aspx?lang=tw" target="_blank" rel="noopener">NVIDIA 驅動程式下載</a>網站選擇型號、作業系統、CUDA版本、語言後即可下載。</p><img src= "/img/loading.gif" data-src="/2020/07/12/ubuntu-install-gpu-driver/download.PNG" class="" title="下載驅動頁面範例"><p>或是透過指令下載</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install wget</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 418.152.00 (CUDA 10.1)</span></span><br><span class="line">wget http://us.download.nvidia.com/tesla/418.152.00/NVIDIA-Linux-x86_64-418.152.00.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 440.95.01 (CUDA 10.2)</span></span><br><span class="line">wget http://us.download.nvidia.com/tesla/440.95.01/NVIDIA-Linux-x86_64-440.95.01.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 450.102.04 (CUDA 11.0)</span></span><br><span class="line">wget https://us.download.nvidia.com/tesla/450.102.04/NVIDIA-Linux-x86_64-450.102.04.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 460.32.03 (CUDA 11.2)</span></span><br><span class="line">wget https://us.download.nvidia.com/tesla/460.32.03/NVIDIA-Linux-x86_64-460.32.03.run</span><br></pre></td></tr></table></figure><h4 id="移除舊有-GPU-驅動-1"><a href="#移除舊有-GPU-驅動-1" class="headerlink" title="移除舊有 GPU 驅動"></a>移除舊有 GPU 驅動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get purge nvidia*</span><br></pre></td></tr></table></figure><h4 id="安裝相依的軟體-1"><a href="#安裝相依的軟體-1" class="headerlink" title="安裝相依的軟體"></a>安裝相依的軟體</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install gcc make cmake dkms build-essential lib32ncurses5 lib32z1</span><br></pre></td></tr></table></figure><h4 id="安裝驅動-1"><a href="#安裝驅動-1" class="headerlink" title="安裝驅動"></a>安裝驅動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash NVIDIA-Linux-x86_64-460.32.03.run</span><br></pre></td></tr></table></figure><h4 id="重新啟動"><a href="#重新啟動" class="headerlink" title="重新啟動"></a>重新啟動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-initramfs -u</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h4 id="驗證安裝-1"><a href="#驗證安裝-1" class="headerlink" title="驗證安裝"></a>驗證安裝</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><h3 id="安裝方法二-apt"><a href="#安裝方法二-apt" class="headerlink" title="安裝方法二 apt"></a>安裝方法二 <code>apt</code></h3><h4 id="安裝-GPU-驅動"><a href="#安裝-GPU-驅動" class="headerlink" title="安裝 GPU 驅動"></a>安裝 GPU 驅動</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:graphics-drivers/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nvidia-driver-460</span><br><span class="line"><span class="meta">#</span><span class="bash"> 不一定要裝</span></span><br><span class="line">sudo apt-get install mesa-common-dev freeglut3-dev</span><br></pre></td></tr></table></figure><h4 id="重啟系統"><a href="#重啟系統" class="headerlink" title="重啟系統"></a>重啟系統</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo reboot</span><br></pre></td></tr></table></figure><h4 id="驗證安裝-2"><a href="#驗證安裝-2" class="headerlink" title="驗證安裝"></a>驗證安裝</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> AI </category>
          
          <category> Install </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NVIDIA </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
